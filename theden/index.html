

<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>The Den - Bear Metal</title>
  <meta name="author" content="Bear Metal OÜ">

  
  <meta name="description" content="One of the projects we&rsquo;re currently working on is a battery powered sensor that needs to send small amounts of data, infrequently, and have a &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://bearmetal.eu/theden">
  <link href="/images/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/theden/atom.xml" rel="alternate" title="Bear Metal" type="application/atom+xml">

    <meta property="og:site_name"
    content="Bear Metal" />
  

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript" src="//use.typekit.net/mba8ekq.js"></script>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
<script type="text/javascript">
  $(document).ready(function($) {
    $('a.expand').click(function(event) {
      $(this).parents('.testimonial').find('.the-rest').addClass('visible').slideDown('500');
      $(this).parents('.read-more').hide();
      return false;
    });
  });
</script>
  <!-- Google Analytics -->
<script  type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-40333336-1', 'auto');
ga('require', 'linkid', 'linkid.js');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->
  <!-- SumoMe -->
<script src="//load.sumome.com/" data-sumo-site-id="da3bead8ae8720119247146e18eb0c9c2a039fdce74750d07f835ee40d1a5604" async="async"></script>
<!-- End SumoMe -->
</head>


<body>
  <header role="banner" class="post row">
  <div class="small-12 large-8 columns small-centered">
    This is <a href="/theden">The Den</a>, a publication crafted by the friendly cubs at <a href="/">Bear <i><img src="/images/bear.png"></i> Metal</a>.
  </div>
</header>

  <section class="row">
<div class="blog-index small-12 large-8 columns small-centered">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/theden/sending-oma-lwm2m-coap-messages-with-quectel-bc68/">Sending OMA LwM2M CoAP Messages With Quectel BC68</a></h1>
    
    
      <p class="meta">
        
  

<span class="byline author vcard"><span class="fn"><a href="/team/erkki/" rel="author">Erkki</a></span> wrote this on </span>

        




<time class='entry-date' datetime='2018-06-29T17:00:00+03:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>29</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>5:00 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the projects we&rsquo;re currently working on is a battery powered sensor that needs to send small amounts of data, infrequently, and have a battery-life measured in years.
We spent quite a bit of time researching <a href="https://en.wikipedia.org/wiki/LoRa">LoRa</a> for this, but have recently settled on <a href="https://en.wikipedia.org/wiki/Narrowband_IoT">Narrowband IoT (NB-Iot)</a> instead.</p>

<blockquote><p>Narrowband IoT (NB-IoT) is a Low Power Wide Area Network (LPWAN) radio technology standard developed by 3GPP to enable a wide range of cellular devices and services. The specification was frozen in 3GPP Release 13 (LTE Advanced Pro), in June 2016. Other 3GPP IoT technologies include eMTC (enhanced Machine-Type Communication) and EC-GSM-IoT.</p><p>NB-IoT focuses specifically on indoor coverage, low cost, long battery life, and high connection density. NB-IoT uses a subset of the LTE standard, but limits the bandwidth to a single narrow-band of 200kHz. It uses OFDM modulation for downlink communication and SC-FDMA for uplink communications.</p></blockquote>


<p>We managed to source a <a href="https://www.quectel.com/product/bc68.htm">Quectel LTE BC68 NB-IoT Module</a> and started to work on data integration, soon realizing that these Neul (which is a company Huawei acquired in 2014) based NB-Iot modems require you to use special <a href="https://en.wikipedia.org/wiki/Hayes_command_set">AT commands</a> to communicate with the outside world (as opposed to &ldquo;normal&rdquo; modems which would require the host to call in using <a href="https://en.wikipedia.org/wiki/Point-to-Point_Protocol">PPP</a>).</p>

<p>Okay, let&rsquo;s scan the <a href="http://www.quectel.com/UploadImage/Downlad/Quectel_BC95-G&BC68_AT_Commands_Manual_V1.1.pdf">Quectel BC95-G&amp;BC68 AT Commands Manual</a>. There&rsquo;s a command for creating UDP sockets, great. Another one for TCP sockets, too. Awesome! And then there&rsquo;s something mysteriously referred to as the &ldquo;Huawei IoT Platform&rdquo;. Wait, what?!?</p>

<p>In TELCO speech it&rsquo;s called a <code>CDP</code> (which stands for Connected Device Platform). It&rsquo;s  a fancy way to describe a gateway that accepts messages from a mobile device and routes them to your application server. There are a few flavours around, such as:</p>

<ul>
<li><a href="http://developer.huawei.com/ict/en/site-oceanconnect/article/ocean-connect-overview">Huawei OceanConnect</a></li>
<li><a href="https://networks.nokia.com/solutions/connected-device-platform">Nokia IMPACT/Connected Device Platform</a></li>
</ul>


<p>But what if we want to use our own server? There are a few reasons one would do this, including cost and efficiency, or the fact that the Huawei partner signup website was broken for two weeks. (Actually turns out it just can&rsquo;t accept <code>Ü</code> as a character in the company name. But I digress.) Nokia CDP on the other hand is only available in the U.S.</p>

<p>Scanning the manual further, there are hints as to what the protocol might be. To set the ip address of the <code>CDP</code> platform, there&rsquo;s a specific AT command for it.</p>

<blockquote><p>6.1. AT+NCDP Configure and Query CDP Server Settings<br/>The command is used to set and query the server IP address and port for the CDP server. It is used when there is a HiSilicon CDP or Huawei’s IoT platform acting as gateway to network server applications. The values assigned are persistent across reboots.</p></blockquote>


<p>And the default port for it is 5683. That&rsquo;s the port for <a href="https://en.wikipedia.org/wiki/Constrained_Application_Protocol">CoAP</a>:</p>

<blockquote><p>Constrained Application Protocol (CoAP) is a specialized Internet Application Protocol for constrained devices, as defined in RFC 7252. It enables those constrained devices called &#8220;nodes&#8221; to communicate with the wider Internet using similar protocols. CoAP is designed for use between devices on the same constrained network (e.g., low-power, lossy networks), between devices and general nodes on the Internet, and between devices on different constrained networks both joined by an internet. CoAP is also being used via other mechanisms, such as SMS on mobile communication networks.</p></blockquote>


<p>Furthermore, another command confirms <a href="https://en.wikipedia.org/wiki/Constrained_Application_Protocol">CoAP</a> and adds <a href="https://en.wikipedia.org/wiki/OMA_LWM2M">OMA LwM2M</a>:</p>

<blockquote><p>6.5. AT+QLWULDATA Send Data<br/>The command is used to send data to Huawei’s IoT platform with LWM2M protocol. It will give an <err> code and description as an intermediate message if the message cannot be sent. Before the module registered to the IoT platform, executing the command will trigger register operation and discard the data. Please refer to Chapter 7 for possible <err> values.</p></blockquote>


<p><a href="https://en.wikipedia.org/wiki/OMA_LWM2M">OMA LwM2M</a> is a protocol that builds on top of <a href="https://en.wikipedia.org/wiki/Constrained_Application_Protocol">CoAP</a></p>

<blockquote><p>OMA Lightweight M2M is a protocol from the Open Mobile Alliance for M2M or IoT device management. Lightweight M2M enabler defines the application layer communication protocol between a LWM2M Server and a LWM2M Client, which is located in a LWM2M Device. The OMA Lightweight M2M enabler includes device management and service enablement for LWM2M Devices. The target LWM2M Devices for this enabler are mainly resource constrained devices. Therefore, this enabler makes use of a light and compact protocol as well as an efficient resource data model. It provides a choice for the M2M Service Provider to deploy a M2M system to provide service to the M2M User. It is frequently used with CoAP</p></blockquote>


<p>With this we&rsquo;re ready for experimentation. Let&rsquo;s fire up the modem, attach it to the network, make it use our own server as the <code>CDP</code> and connect it to <a href="https://www.eclipse.org/wakaama/">Eclipse Wakaama</a> running on the server.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Boot: Unsigned
</span><span class='line'>Security B.. Verified
</span><span class='line'>Protocol A.. Verified
</span><span class='line'>Apps A...... Verified
</span><span class='line'>REBOOT_CAUSE_SECURITY_RESET_PIN
</span><span class='line'>Neul
</span><span class='line'>OK
</span><span class='line'>AT+CFUN=0
</span><span class='line'>OK
</span><span class='line'>AT+NCDP=198.51.100.1
</span><span class='line'>OK
</span><span class='line'>AT+CFUN=1
</span><span class='line'>OK
</span><span class='line'>AT+CGDCONT=1,"IP","APN"
</span><span class='line'>OK
</span><span class='line'>AT+CSCON=1
</span><span class='line'>OK
</span><span class='line'>AT+CEREG=1
</span><span class='line'>OK
</span><span class='line'>AT+CGATT=1
</span><span class='line'>OK
</span><span class='line'>+CEREG:2
</span><span class='line'>+CSCON:1
</span><span class='line'>+CEREG:1
</span><span class='line'>AT+NPING=198.51.100.1
</span><span class='line'>OK
</span><span class='line'>+NPING:198.51.100.1,54,962</span></code></pre></td></tr></table></div></figure>


<p>Once the modem boots up, we</p>

<ul>
<li>disable the radio <code>AT+CFUN=0</code></li>
<li>set the CDP to our server <code>AT+NCDP=198.51.100.1</code></li>
<li>re-enable the radio again <code>AT+CFUN=1</code></li>
<li>configure the APN (value depends on your provider) <code>AT+CGDCONT=1,"IP","APN"</code></li>
<li>enable <code>AT+CSCON=1</code> and <code>AT+CEREG=1</code> to monitor network connection and registration status</li>
<li>attach to the network <code>AT+CGATT=1</code></li>
<li>once we see <code>+CSCON:1</code> and <code>+CEREG:1</code> we can send a test ping with <code>AT+NPING=198.51.100.1</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>AT+QLWSREGIND<span class="o">=</span>0
</span><span class='line'>OK
</span><span class='line'>+CSCON:1
</span><span class='line'>+QLWEVTIND:0
</span></code></pre></td></tr></table></div></figure>


<p>Sending <code>AT+QLWSREGIND=0</code> initiates the registration process and receiving <code>+QLWEVTIND:0</code> means registration was successful. We can observe this with <code>tcpdump</code> and <code>lwm2mserver</code> included in <code>wakaama</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>20:32:00.417221 IP 198.51.100.2.19000 &gt; 198.51.100.1.5683: UDP, length 119
</span><span class='line'>  0x0000:  <span class="m">4500</span> <span class="m">0093</span> <span class="m">0013</span> <span class="m">0000</span> fa11 0c0f 92ff b496  E...............
</span><span class='line'>  0x0010:  b99e b303 4a38 <span class="m">1633</span> 007f 137c <span class="m">4402</span> <span class="m">2862</span>  ....J8.3...<span class="p">|</span>D.<span class="o">(</span>b
</span><span class='line'>  0x0020:  <span class="m">2862</span> a813 b272 <span class="m">6411</span> <span class="m">2839</span> 6c77 6d32 6d3d  <span class="o">(</span>b...rd.<span class="o">(</span><span class="nv">9lwm2m</span><span class="o">=</span>
</span><span class='line'>  0x0030:  312e 300d <span class="m">0565</span> 703d <span class="m">3836</span> <span class="m">3737</span> <span class="m">3233</span> <span class="m">3033</span>  1.0..ep<span class="o">=</span>86772303
</span><span class='line'>  0x0040:  <span class="m">3030</span> <span class="m">3035</span> <span class="m">3635</span> <span class="m">3503</span> 623d <span class="m">5508</span> 6c74 3d38  0005655.b<span class="o">=</span>U.lt<span class="o">=</span>8
</span><span class='line'>  0x0050:  <span class="m">3634</span> <span class="m">3030</span> ff3c 2f3e 3b72 743d 226f 6d61  6400.&lt;/&gt;<span class="p">;</span><span class="nv">rt</span><span class="o">=</span><span class="s2">&quot;oma</span>
</span><span class='line'><span class="s2"> 0x0060:  2e6c 776d 326d 222c 3c2f 312f 303e 2c3c  .lwm2m&quot;</span>,&lt;/1/0&gt;,&lt;
</span><span class='line'>  0x0070:  2f33 2f30 3e2c 3c2f 342f 303e 2c3c 2f31  /3/0&gt;,&lt;/4/0&gt;,&lt;/1
</span><span class='line'>  0x0080:  392f 303e 2c3c 2f35 2f30 3e2c 3c2f <span class="m">3230</span>  9/0&gt;,&lt;/5/0&gt;,&lt;/20
</span><span class='line'>  0x0090:  2f30 3e                                  /0&gt;
</span><span class='line'>20:32:00.417622 IP 198.51.100.1.5683 &gt; 198.51.100.2.19000: UDP, length 13
</span><span class='line'>  0x0000:  <span class="m">4500</span> <span class="m">0029</span> 7ae4 <span class="m">4000</span> <span class="m">4011</span> 0ba8 b99e b303  E..<span class="o">)</span>z.@.@.......
</span><span class='line'>  0x0010:  92ff b496 <span class="m">1633</span> 4a38 <span class="m">0015</span> b45e <span class="m">6441</span> <span class="m">2862</span>  .....3J8...^dA<span class="o">(</span>b
</span><span class='line'>  0x0020:  <span class="m">2862</span> a813 <span class="m">8272</span> <span class="m">6401</span> <span class="m">30</span>                   <span class="o">(</span>b...rd.0
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>~/wakaama# ./lwm2mserver
</span><span class='line'><span class="m">119</span> bytes received from <span class="o">[</span>::ffff:198.51.100.2<span class="o">]</span>:19000
</span><span class='line'><span class="m">44</span> <span class="m">02</span> <span class="m">28</span> <span class="m">62</span>  <span class="m">28</span> <span class="m">62</span> A8 <span class="m">13</span>  B2 <span class="m">72</span> <span class="m">64</span> <span class="m">11</span>  <span class="m">28</span> <span class="m">39</span> 6C <span class="m">77</span>   D.<span class="o">(</span>b<span class="o">(</span>b...rd.<span class="o">(</span>9lw
</span><span class='line'>6D <span class="m">32</span> 6D 3D  <span class="m">31</span> 2E <span class="m">30</span> 0D  <span class="m">05</span> <span class="m">65</span> <span class="m">70</span> 3D  <span class="m">38</span> <span class="m">36</span> <span class="m">37</span> <span class="m">37</span>   <span class="nv">m2m</span><span class="o">=</span>1.0..ep<span class="o">=</span>8677
</span><span class='line'><span class="m">32</span> <span class="m">33</span> <span class="m">30</span> <span class="m">33</span>  <span class="m">30</span> <span class="m">30</span> <span class="m">30</span> <span class="m">35</span>  <span class="m">36</span> <span class="m">35</span> <span class="m">35</span> <span class="m">03</span>  <span class="m">62</span> 3D <span class="m">55</span> <span class="m">08</span>   23030005655.b<span class="o">=</span>U.
</span><span class='line'>6C <span class="m">74</span> 3D <span class="m">38</span>  <span class="m">36</span> <span class="m">34</span> <span class="m">30</span> <span class="m">30</span>  FF 3C 2F 3E  3B <span class="m">72</span> <span class="m">74</span> 3D   <span class="nv">lt</span><span class="o">=</span>86400.&lt;/&gt;<span class="p">;</span><span class="nv">rt</span><span class="o">=</span>
</span><span class='line'><span class="m">22</span> 6F 6D <span class="m">61</span>  2E 6C <span class="m">77</span> 6D  <span class="m">32</span> 6D <span class="m">22</span> 2C  3C 2F <span class="m">31</span> 2F   <span class="s2">&quot;oma.lwm2m&quot;</span>,&lt;/1/
</span><span class='line'><span class="m">30</span> 3E 2C 3C  2F <span class="m">33</span> 2F <span class="m">30</span>  3E 2C 3C 2F  <span class="m">34</span> 2F <span class="m">30</span> 3E   0&gt;,&lt;/3/0&gt;,&lt;/4/0&gt;
</span><span class='line'>2C 3C 2F <span class="m">31</span>  <span class="m">39</span> 2F <span class="m">30</span> 3E  2C 3C 2F <span class="m">35</span>  2F <span class="m">30</span> 3E 2C   ,&lt;/19/0&gt;,&lt;/5/0&gt;,
</span><span class='line'>3C 2F <span class="m">32</span> <span class="m">30</span>  2F <span class="m">30</span> 3E                                &lt;/20/0&gt;
</span><span class='line'>
</span><span class='line'>New client <span class="c">#0 registered.</span>
</span><span class='line'>Client <span class="c">#0:</span>
</span><span class='line'>  name: <span class="s2">&quot;867723030005655&quot;</span>
</span><span class='line'>  binding: <span class="s2">&quot;UDP&quot;</span>
</span><span class='line'>  lifetime: <span class="m">86400</span> sec
</span><span class='line'>  objects: /1/0, /3/0, /4/0, /5/0, /19/0, /20/0,
</span></code></pre></td></tr></table></div></figure>


<p>Great! We&rsquo;ve registered the modem. Let&rsquo;s try sending data with <code>AT+QLWULDATA</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>AT+QLWULDATA<span class="o">=</span>4,DEADBEEF
</span><span class='line'>ERROR
</span><span class='line'>+CSCON:1
</span><span class='line'>+QLWEVTIND:0
</span></code></pre></td></tr></table></div></figure>


<p>This is a failure. Not only does it error out, it actually triggers a new registration process. Something is missing. Scanning the docs again, there&rsquo;s a reference to <code>+QLWEVTIND:3</code> being sent when:</p>

<blockquote><p>//IoT platform has observed the data object 19. When the module reports this message, the customer can send data to the IoT platform.</p></blockquote>


<p>This took me a while to figure out, but became clear after reading more about <a href="https://en.wikipedia.org/wiki/OMA_LWM2M">OMA LwM2M</a>. More specifically, <code>object 19</code> as specified in <a href="http://www.openmobilealliance.org/wp/OMNA/LwM2M/LwM2MRegistry.html">OMA LightweightM2M (LwM2M) Object and Resource Registry</a> means <code>LwM2M APPDATA</code>:</p>

<blockquote><p>This LwM2M object provides the application service data related to a LwM2M Server, eg. Water meter data.</p></blockquote>


<p>This is further specified in <a href="http://www.openmobilealliance.org/release/LwM2M_APPDATA/V1_0-20171205-C/OMA-TS-LWM2M_BinaryAppDataContainer-V1_0-20171205-C.pdf">Lightweight M2M – Binary App Data Container</a>.</p>

<p>Things are getting clearer now. For the modem to send out data, it tunnels the data inside object 19 and the server has to subscribe to receiving messages on that object. In <code>lwm2mserver</code> there&rsquo;s a command for it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>&gt; observe <span class="m">0</span> /19/0/0
</span><span class='line'>OK
</span></code></pre></td></tr></table></div></figure>


<p>Observe request and ACK in tcpdump:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>20:44:03.122190 IP 198.51.100.1.5683 &gt; 198.51.100.2.61500: UDP, length 19
</span><span class='line'>  0x0000:  <span class="m">4500</span> 002f b3fa <span class="m">4000</span> <span class="m">4011</span> d289 b99e b303  E../..@.@.......
</span><span class='line'>  0x0010:  92ff b498 <span class="m">1633</span> f03c 001b b466 <span class="m">4401</span> f4a6  .....3.&lt;...fD...
</span><span class='line'>  0x0020:  <span class="m">0000</span> <span class="m">0000</span> <span class="m">6052</span> <span class="m">3139</span> <span class="m">0130</span> <span class="m">0130</span> 622d <span class="m">16</span>    ....<span class="sb">`</span>R19.0.0b-.
</span><span class='line'>20:44:04.232286 IP 198.51.100.2.61500 &gt; 198.51.100.1.5683: UDP, length 10
</span><span class='line'>  0x0000:  <span class="m">4500</span> <span class="m">0026</span> <span class="m">0016</span> <span class="m">0000</span> fa11 0c77 92ff b498  E..<span class="p">&amp;</span>.......w....
</span><span class='line'>  0x0010:  b99e b303 f03c <span class="m">1633</span> <span class="m">0012</span> 8bd3 <span class="m">6445</span> f4a6  .....&lt;.3....dE..
</span><span class='line'>  0x0020:  <span class="m">0000</span> <span class="m">0000</span> <span class="m">6060</span> <span class="m">0000</span> <span class="m">0000</span> <span class="m">0000</span> <span class="m">0000</span>       ....<span class="sb">``</span>........
</span></code></pre></td></tr></table></div></figure>


<p>Meanwhile on the modem side, we&rsquo;ve received the <code>+QLWEVTIND:3</code> message and can send data now:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>+QLWEVTIND:3
</span><span class='line'>AT+QLWULDATA<span class="o">=</span>3,AA34BB
</span><span class='line'>OK
</span><span class='line'>+CSCON:1
</span></code></pre></td></tr></table></div></figure>


<p>On the <code>lwm2mserver</code> side we can see data coming in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="m">15</span> bytes received from <span class="o">[</span>::ffff:198.51.100.2<span class="o">]</span>:61500
</span><span class='line'><span class="m">54</span> <span class="m">45</span> <span class="m">28</span> <span class="m">66</span>  <span class="m">00</span> <span class="m">00</span> <span class="m">00</span> <span class="m">00</span>  C1 2A FF DE  AD BE EF  TE<span class="o">(</span>f.....*.....
</span></code></pre></td></tr></table></div></figure>


<p>Yay! We can now successfully receive data from the modem. In follow-up posts, we&rsquo;ll try to figure out the differences between <code>AT+QLWULDATA</code> and <code>AT+NMGS</code>, look at receiving data from the server, and maybe write our own LwM2M server to forward data to MQTT.</p>
</div>
  
  


    </article>
    <div id="ck_embed_form" class="ck_embed_form row">
  <div class="small-12 large-6 columns" id="ck_form_content">
    <h3 class="ck_embed_form_title">Get our Secrets of Successful Web Apps email course for free!</h3>
    <div class="ck_embed_description">
      <span class="ck_image">

      </span>
        <p>Sign up to get the lessons we&#8217;ve spent more than a decade learning straight to your inbox. 100% meat, no spam, ever.</p>
    </div>
  </div>
<div id='ck_success_msg' class='fade' style='display:none;'>
  <p>Thanks! Now check your email, confirm your subscription, and off we go!</p>
</div>
  <!--  Form starts here  -->
  <form id="ck_subscribe_form" class="small-12 large-6 columns" action="https://convertkit.com/app/landing_pages/259/subscribe">
    <input type="hidden" name="id" value="259" id="landing_page_id"></input>
    <p class="ck_errorArea"></p>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_firstNameField">First Name</label>
      <input type="text" name="first_name" class="ck_first_name" id="ck_firstNameField"></input>
    </div>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_emailField">Email Address</label>
        <input type="email" name="email" class="ck_email_address" id="ck_emailField"></input>
    </div>
    <label class="ck_checkbox">
      <input class="optIn ck_course_opted" type="checkbox" id="optIn" checked />
      I&#8217;d like to receive a free 30 day course by email.
    </label>

    <button class="subscribe_button ck_subscribe_button btn fields" id='ck_subscribe_button'>
      Claim my spot on the course
    </button>
    <span class="ck_guarantee">We won&#8217;t send you spam. Unsubscribe at any time.</span>
  </form>
</div>

<script src="https://convertkit.com/assets/CKJS4.js"></script>



  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/theden/hosted-mender-getting-started-on-osx-and-raspberry-pi-3/">Hosted Mender Getting Started on OSX and Raspberry Pi 3</a></h1>
    
    
      <p class="meta">
        
  

<span class="byline author vcard"><span class="fn"><a href="/team/erkki/" rel="author">Erkki</a></span> wrote this on </span>

        




<time class='entry-date' datetime='2018-02-12T07:00:00+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2018</span></span> <span class='time'>7:00 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Having various embedded linux devices around (mostly Raspberry Pi&rsquo;s), and a few client projects dealing with software updates to remote devices, I&rsquo;ve become interested in fleet management. More specifically, I wanted:</p>

<ul>
<li>inventory management</li>
<li><a href="https://source.android.com/devices/tech/ota/ab/">A/B partition updates</a></li>
<li>integrity checks</li>
<li>signed updates</li>
</ul>


<p>I&rsquo;ve heard about <a href="https://resin.io/">resin.io</a> before, and while appealing, the control freak in me wanted something with an open server infrastructrure. I&rsquo;m also not sold on having docker in production embedded devices (while surely being useful for prototyping and experimentation).</p>

<p>There&rsquo;s the <a href="https://nerves-project.org">nerves project</a>, mostly focused around the elixir ecosystem. Something I definitely want to check out in more detail, both to learn more about elixir and for simpler embedded projects.</p>

<p>Then I stumbled onto <a href="https://mender.io/">mender</a>. On first glance, it seems perfect. Let&rsquo;s take a look, shall we?</p>

<h1>Burning the initial image</h1>

<p>We&rsquo;re gonna be roughly following along the <a href="https://docs.mender.io/1.3/getting-started">mender getting started guide</a> while keeping things OSX compatible.</p>

<p>Instead of running our own server infrastructure (which is nice to have as an option, but not required for initial experimenting), we&rsquo;ll be using <a href="https://hosted.mender.io/">hosted mender</a>. That means we will have to inject our hosted mender token into the initial disk image what we will boot the RPi3 from.</p>

<p>Download the Raspberry Pi 3 disk image from <a href="https://docs.mender.io/1.3/getting-started/download-test-images">https://docs.mender.io/1.3/getting-started/download-test-images</a> .
Decompress and change the file extension to make it palatable for <code>hdiutil</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>wget https://d1b0l86ne08fsf.cloudfront.net/1.3.1/raspberrypi3/mender-raspberrypi3_1.3.1.sdimg.gz
</span><span class='line'>gunzip mender-raspberrypi3_1.3.1.sdimg.gz
</span><span class='line'>mv mender-raspberrypi3_1.3.1.sdimg mender-raspberrypi3_1.3.1.img
</span></code></pre></td></tr></table></div></figure>


<p>Verify we have a good image</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>hdiutil imageinfo mender-raspberrypi3_1.3.1.img
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Backing Store Information:
</span><span class='line'>  URL: file:///Users/erkkieilonen/projects/learning/mender/mender-raspberrypi3_1.3.1.img
</span><span class='line'>  Name: mender-raspberrypi3_1.3.1.img
</span><span class='line'>  Class Name: CBSDBackingStore
</span><span class='line'>Class Name: CRawDiskImage
</span><span class='line'>Checksum Type: none
</span><span class='line'>Size Information:
</span><span class='line'>  Total Bytes: 624951296
</span><span class='line'>  Compressed Ratio: 1
</span><span class='line'>  Sector Count: 1220608
</span><span class='line'>  Total Non-Empty Bytes: 624951296
</span><span class='line'>  Compressed Bytes: 624951296
</span><span class='line'>  Total Empty Bytes: 0
</span><span class='line'>Format: RAW*
</span><span class='line'>Format Description: raw <span class="nb">read</span>/write
</span><span class='line'>Checksum Value:
</span><span class='line'>Properties:
</span><span class='line'>  Encrypted: <span class="nb">false</span>
</span><span class='line'><span class="nb"> </span>Kernel Compatible: <span class="nb">true</span>
</span><span class='line'><span class="nb"> </span>Checksummed: <span class="nb">false</span>
</span><span class='line'><span class="nb"> </span>Software License Agreement: <span class="nb">false</span>
</span><span class='line'><span class="nb"> </span>Partitioned: <span class="nb">false</span>
</span><span class='line'><span class="nb"> </span>Compressed: no
</span><span class='line'>Segments:
</span><span class='line'>  0: /Users/erkkieilonen/projects/learning/mender/mender-raspberrypi3_1.3.1.img
</span><span class='line'>partitions:
</span><span class='line'>  partition-scheme: fdisk
</span><span class='line'>  block-size: 512
</span><span class='line'>  partitions:
</span><span class='line'>      0:
</span><span class='line'>          partition-name: Master Boot Record
</span><span class='line'>          partition-start: 0
</span><span class='line'>          partition-synthesized: <span class="nb">true</span>
</span><span class='line'><span class="nb">         </span>partition-length: 1
</span><span class='line'>          partition-hint: MBR
</span><span class='line'>          boot-code: 0xFAB800108ED0BC00B0B800008ED88EC0FBBE007CBF0006B90002F3A4EA21060000BEBE073804750B83C61081FEFE0775F3EB16B402B001BB007CB2808A74018B4C02CD13EA007C0000EBFE0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000A31D6D430000
</span><span class='line'>      1:
</span><span class='line'>          partition-name:
</span><span class='line'>          partition-start: 1
</span><span class='line'>          partition-synthesized: <span class="nb">true</span>
</span><span class='line'><span class="nb">         </span>partition-length: 24575
</span><span class='line'>          partition-hint: Apple_Free
</span><span class='line'>      2:
</span><span class='line'>          partition-start: 24576
</span><span class='line'>          partition-number: 1
</span><span class='line'>          partition-length: 81920
</span><span class='line'>          partition-hint: Windows_FAT_32
</span><span class='line'>          partition-filesystems:
</span><span class='line'>              FAT16: boot
</span><span class='line'>      3:
</span><span class='line'>          partition-start: 106496
</span><span class='line'>          partition-number: 2
</span><span class='line'>          partition-length: 425984
</span><span class='line'>          partition-hint: Linux_Ext2FS
</span><span class='line'>      4:
</span><span class='line'>          partition-start: 532480
</span><span class='line'>          partition-number: 3
</span><span class='line'>          partition-length: 425984
</span><span class='line'>          partition-hint: Linux_Ext2FS
</span><span class='line'>      5:
</span><span class='line'>          partition-start: 958464
</span><span class='line'>          partition-number: 4
</span><span class='line'>          partition-length: 262144
</span><span class='line'>          partition-hint: Linux_Ext2FS
</span><span class='line'>  burnable: <span class="nb">false</span>
</span><span class='line'>Resize limits <span class="o">(</span>per hdiutil resize -limits<span class="o">)</span>:
</span><span class='line'> min   cur     max
</span><span class='line'>1220608   1220608 1245311712
</span></code></pre></td></tr></table></div></figure>


<p>We can see the boot partition, the primary and secondary root partitions and the data partition.
Since the root partitions are using ext2fs, and we&rsquo;re on OSX, we need to install <a href="https://osxfuse.github.io">FUSE for macOS</a> along with <a href="https://github.com/alperakcan/fuse-ext2">FUSE-Ext2</a> to be able to mount and write to these partitions.</p>

<h2>FUSE for macOS</h2>

<p>Download the OSX package from <a href="https://osxfuse.github.io">https://osxfuse.github.io</a> and follow the instructions to install it. Make sure to tick the checkbox for <code>MacFUSE Compatibility Layer</code>. That&rsquo;s required for <code>FUSE-Ext2</code>  support.</p>

<h2>FUSE-Ext2</h2>

<p>This gets a little more complicated.
Instead of compiling everything from source, like described <a href="https://github.com/alperakcan/fuse-ext2#mac-os">here</a>, we&rsquo;re using the excellent <a href="https://brew.sh">Homebrew</a> package manager to install the dependencies and just compile <code>FUSE-Ext2</code> itself. (we should probably create a formula for FUSE-Ext2 too &hellip;)</p>

<p>Install the dependencies</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>brew install m4 autoconf automake libtool e2fsprogs
</span></code></pre></td></tr></table></div></figure>


<p>Install <code>FUSE-Ext2</code> itself</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone https://github.com/alperakcan/fuse-ext2.git
</span><span class='line'><span class="nb">cd </span>fuse-ext2
</span><span class='line'>./autogen.sh
</span><span class='line'>./configure
</span><span class='line'><span class="nv">CFLAGS</span><span class="o">=</span><span class="s2">&quot;-I /usr/local/include -I $(brew --prefix e2fsprogs)/include&quot;</span> <span class="nv">LDFLAGS</span><span class="o">=</span><span class="s2">&quot;-L/usr/local/lib -L$(brew --prefix e2fsprogs)/lib&quot;</span> ./configure
</span><span class='line'>make
</span><span class='line'>sudo make install
</span><span class='line'><span class="nb">cd</span> ..
</span></code></pre></td></tr></table></div></figure>


<p>Attach the original mender image</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>hdiutil attach mender-raspberrypi3_1.3.1.img
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/dev/disk2           FDisk_partition_scheme
</span><span class='line'>/dev/disk2s1          Windows_FAT_32                  /Volumes/boot
</span><span class='line'>/dev/disk2s2          Linux
</span><span class='line'>/dev/disk2s3          Linux
</span><span class='line'>/dev/disk2s4          Linux
</span></code></pre></td></tr></table></div></figure>


<p>Since <code>/dev/disk1</code> is our OSX boot disk, and we have nothing else mounted, <code>/dev/disk2</code> is the <code>.img</code> file we just attached. Pay attention to use the correct device in case you have more disks attached.</p>

<p>We will have to mount both of the root partitions and edit some files in there.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mkdir <span class="k">$(</span>e2label /dev/disk2s2<span class="k">)</span>
</span><span class='line'>mkdir <span class="k">$(</span>e2label /dev/disk2s3<span class="k">)</span>
</span><span class='line'>mount -t fuse-ext2 -o rw /dev/disk2s2 <span class="k">$(</span>e2label /dev/disk2s2<span class="k">)</span>
</span><span class='line'>mount -t fuse-ext2 -o rw /dev/disk2s3 <span class="k">$(</span>e2label /dev/disk2s3<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Grab your <a href="https://hosted.mender.io">hosted mender</a> token (  top right menu, under <em>My organization</em>) and inject it to the image.
Replace <code>&lt;token from hosted mender&gt;</code> with your token.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sed -ibak <span class="s1">&#39;s/dummy/&lt;token from hosted mender&gt;/&#39;</span> primary/etc/mender/mender.conf
</span><span class='line'>sed -ibak <span class="s1">&#39;s/docker.mender.io/hosted.mender.io/&#39;</span> primary/etc/mender/mender.conf
</span><span class='line'>sed -ibak <span class="s1">&#39;s/dummy/&lt;token from hosted mender&gt;/&#39;</span> secondary/etc/mender/mender.conf
</span><span class='line'>sed -ibak <span class="s1">&#39;s/docker.mender.io/hosted.mender.io/&#39;</span> secondary/etc/mender/mender.conf
</span></code></pre></td></tr></table></div></figure>


<p>Verify the config file contents</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat primary/etc/mender/mender.conf
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;InventoryPollIntervalSeconds&quot;</span>: 5,
</span><span class='line'>    <span class="s2">&quot;RetryPollIntervalSeconds&quot;</span>: 1,
</span><span class='line'>    <span class="s2">&quot;RootfsPartA&quot;</span>: <span class="s2">&quot;/dev/mmcblk0p2&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;RootfsPartB&quot;</span>: <span class="s2">&quot;/dev/mmcblk0p3&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;ServerCertificate&quot;</span>: <span class="s2">&quot;/etc/mender/server.crt&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;ServerURL&quot;</span>: <span class="s2">&quot;https://hosted.mender.io&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;TenantToken&quot;</span>: <span class="s2">&quot;&lt;token from hosted mender&gt;&quot;</span>,
</span><span class='line'>    <span class="s2">&quot;UpdatePollIntervalSeconds&quot;</span>: 5
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unmount and burn the image and we&rsquo;re done. Adjust <code>/dev/disk3</code> to your sdcard device.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>umount primary
</span><span class='line'>umount secondary
</span><span class='line'>hdiutil detach /dev/disk2
</span><span class='line'>sudo dd <span class="k">if</span><span class="o">=</span>mender-raspberrypi3_1.3.1.img <span class="nv">of</span><span class="o">=</span>/dev/disk3 <span class="nv">bs</span><span class="o">=</span>1m <span class="o">&amp;&amp;</span> sudo sync
</span><span class='line'>hdiutil detach /dev/disk3
</span></code></pre></td></tr></table></div></figure>


<p>Boot the RPi and check mender dashboard, you should see a new authorization request pop up.</p>

<p><img src="/images/mender/mender_auth_list.png" /></p>
</div>
  
  


    </article>
    <div id="ck_embed_form" class="ck_embed_form row">
  <div class="small-12 large-6 columns" id="ck_form_content">
    <h3 class="ck_embed_form_title">Get our Secrets of Successful Web Apps email course for free!</h3>
    <div class="ck_embed_description">
      <span class="ck_image">

      </span>
        <p>Sign up to get the lessons we&#8217;ve spent more than a decade learning straight to your inbox. 100% meat, no spam, ever.</p>
    </div>
  </div>
<div id='ck_success_msg' class='fade' style='display:none;'>
  <p>Thanks! Now check your email, confirm your subscription, and off we go!</p>
</div>
  <!--  Form starts here  -->
  <form id="ck_subscribe_form" class="small-12 large-6 columns" action="https://convertkit.com/app/landing_pages/259/subscribe">
    <input type="hidden" name="id" value="259" id="landing_page_id"></input>
    <p class="ck_errorArea"></p>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_firstNameField">First Name</label>
      <input type="text" name="first_name" class="ck_first_name" id="ck_firstNameField"></input>
    </div>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_emailField">Email Address</label>
        <input type="email" name="email" class="ck_email_address" id="ck_emailField"></input>
    </div>
    <label class="ck_checkbox">
      <input class="optIn ck_course_opted" type="checkbox" id="optIn" checked />
      I&#8217;d like to receive a free 30 day course by email.
    </label>

    <button class="subscribe_button ck_subscribe_button btn fields" id='ck_subscribe_button'>
      Claim my spot on the course
    </button>
    <span class="ck_guarantee">We won&#8217;t send you spam. Unsubscribe at any time.</span>
  </form>
</div>

<script src="https://convertkit.com/assets/CKJS4.js"></script>



  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/theden/lte-roaming-data-on-mikrotik-huawei/">Enable LTE Roaming on a Mikrotik Router With Huawei ME909u-521 Modem</a></h1>
    
    
      <p class="meta">
        
  

<span class="byline author vcard"><span class="fn"><a href="/team/erkki/" rel="author">Erkki</a></span> wrote this on </span>

        




<time class='entry-date' datetime='2018-01-31T06:00:00+02:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2018</span></span> <span class='time'>6:00 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>MikroTik by default doesn&rsquo;t enable roaming when used with a non-local sim card. This puzzled us as everything seemed to be configured correctly but the LTE interface wasn&rsquo;t getting any ip addresses. This is how to log in to your router and enable roaming.</p>

<p>Log in to the MikroTik box. We&rsquo;re using the command-line interface via ssh but you could use the web UI too.
If you haven&rsquo;t done this before, check out <a href="https://wiki.mikrotik.com/wiki/Manual:First_time_startup">First time startup</a></p>

<blockquote><p>Every router is factory pre-configured with the IP address 192.168.88.1/24 on the ether1 port. The default username is admin with no password.</p></blockquote>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>➜ ssh admin@192.168.88.1
</span><span class='line'>  MMM      MMM       KKK                          TTTTTTTTTTT      KKK
</span><span class='line'>  MMMM    MMMM       KKK                          TTTTTTTTTTT      KKK
</span><span class='line'>  MMM MMMM MMM  III  KKK  KKK  RRRRRR     OOOOOO      TTT     III  KKK  KKK
</span><span class='line'>  MMM  MM  MMM  III  KKKKK     RRR  RRR  OOO  OOO     TTT     III  KKKKK
</span><span class='line'>  MMM      MMM  III  KKK KKK   RRRRRR    OOO  OOO     TTT     III  KKK KKK
</span><span class='line'>  MMM      MMM  III  KKK  KKK  RRR  RRR   OOOOOO      TTT     III  KKK  KKK
</span><span class='line'>
</span><span class='line'>  MikroTik RouterOS 6.39.2 <span class="o">(</span>c<span class="o">)</span> 1999-2017       http://www.mikrotik.com/
</span><span class='line'>
</span><span class='line'><span class="o">[</span>?<span class="o">]</span>             Gives the list of available commands
</span><span class='line'><span class="nb">command</span> <span class="o">[</span>?<span class="o">]</span>     Gives <span class="nb">help </span>on the <span class="nb">command </span>and list of arguments
</span><span class='line'>
</span><span class='line'><span class="o">[</span>Tab<span class="o">]</span>           Completes the <span class="nb">command</span>/word. If the input is ambiguous,
</span><span class='line'>                a second <span class="o">[</span>Tab<span class="o">]</span> gives possible options
</span><span class='line'>
</span><span class='line'>/               Move up to base level
</span><span class='line'>..              Move up one level
</span><span class='line'>/command        Use <span class="nb">command </span>at the base level
</span><span class='line'>
</span><span class='line'><span class="o">[</span>admin@MikroTik<span class="o">]</span> &gt;
</span></code></pre></td></tr></table></div></figure>


<p>We checked the LTE interface and realized it is not joining any networks. If you can&rsquo;t see the LTE interface/modem at all, you need to enable the mini-PCIe interface.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>admin@MikroTik<span class="o">]</span> /interface lte info lte1 once
</span><span class='line'>     pin-status: no password required
</span><span class='line'>  functionality: full
</span><span class='line'>   manufacturer: Huawei Technologies Co., Ltd.
</span><span class='line'>          model: ME909u-521
</span><span class='line'>       revision: 12.636.12.01.00
</span><span class='line'>           imei: &lt;redacted&gt;
</span><span class='line'>           imsi: &lt;redacted&gt;
</span><span class='line'>           uicc: &lt;redacted&gt;
</span></code></pre></td></tr></table></div></figure>


<p>With the help of the <a href="http://download-c.huawei.com/download/downloadCenter?downloadId=29741&version=72288&siteCode=">AT Command Interface Specification for the HUAWEI ME906s LTE M.2 Module</a> we can see roaming status is queried and set using the <code>AT^SYSCFGEX</code> command.</p>

<p>To check existing roaming status, we need to look at the third parameter returned. Notice that we&rsquo;re escaping the question mark <code>?</code> with the backslash character <code>\</code>. This is because the command line interface interprets <code>?</code> as the help command.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>admin@MikroTik<span class="o">]</span> &gt; /interface lte at-chat lte1 <span class="nv">input</span><span class="o">=</span><span class="s2">&quot;AT^SYSCFGEX\?&quot;</span>
</span><span class='line'>  output: ^SYSCFGEX: <span class="s2">&quot;00&quot;</span>,3FFFFFFF,0,1,7FFFFFFFFFFFFFFF
</span><span class='line'>
</span><span class='line'>OK
</span></code></pre></td></tr></table></div></figure>


<table>
<thead>
<tr>
<th> <code>AT^SYSCFGEX=?</code> </th>
</tr>
</thead>
<tbody>
<tr>
<td> Possible Response(s) </td>
</tr>
<tr>
<td> <code>&lt;CR&gt;&lt;LF&gt;^SYSCFGEX</code>: (list of supported <code>&lt;acqorder&gt;</code>s),(list of supported (<code>&lt;band&gt;</code>,<code>&lt;band_name&gt;</code>)s),(list of supported <code>&lt;roam&gt;</code>s),(list of supported <code>&lt;srvdomain&gt;</code>s),(list of supported (<code>&lt;lteband&gt;</code>,<code>&lt;lteband_name&gt;</code>)s)<code>&lt;CR&gt;&lt;LF&gt;&lt;CR&gt;&lt;LF&gt;OK&lt;CR&gt;&lt;LF&gt;</code> </td>
</tr>
</tbody>
</table>


<table>
<thead>
<tr>
<th> <code>&lt;roam&gt;</code>: indicates whether roaming is supported. </th>
</tr>
</thead>
<tbody>
<tr>
<td> 0 Not supported </td>
</tr>
<tr>
<td> 1 Supported </td>
</tr>
<tr>
<td> 2 No change </td>
</tr>
</tbody>
</table>


<p><code>0</code> here means roaming not enabled. Lets set it to <code>1</code> instead (notice that we&rsquo;re keeping all the rest of the parameters unchanged from the output of the previous command).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>admin@MikroTik<span class="o">]</span> &gt; /interface lte at-chat lte1 <span class="nv">input</span><span class="o">=</span><span class="s2">&quot;AT^SYSCFGEX=\&quot;00\&quot;,3FFFFFFF,1,1,7FFFFFFFFFFFFFFF,,&quot;</span>
</span><span class='line'>  output: OK
</span></code></pre></td></tr></table></div></figure>


<p>Query the status again.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>admin@MikroTik<span class="o">]</span> &gt; /interface lte at-chat lte1 <span class="nv">input</span><span class="o">=</span><span class="s2">&quot;AT^SYSCFGEX\?&quot;</span>
</span><span class='line'>  output: ^SYSCFGEX: <span class="s2">&quot;00&quot;</span>,3FFFFFFF,1,1,7FFFFFFFFFFFFFFF
</span></code></pre></td></tr></table></div></figure>


<p>Boom, roaming enbled. Verify with <code>lte info</code> to make sure we&rsquo;re registered to a network.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>admin@MikroTik<span class="o">]</span> /interface lte info lte1 once
</span><span class='line'>         pin-status: no password required
</span><span class='line'>      functionality: full
</span><span class='line'>       manufacturer: Huawei Technologies Co., Ltd.
</span><span class='line'>              model: ME909u-521
</span><span class='line'>           revision: 12.636.12.01.00
</span><span class='line'>   current-operator: EE Elisa
</span><span class='line'>                lac: 24
</span><span class='line'>     current-cellid: 256268822
</span><span class='line'>  access-technology: Evolved 3G <span class="o">(</span>LTE<span class="o">)</span>
</span><span class='line'>     session-uptime: 1m10s
</span><span class='line'>               imei: &lt;redacted&gt;
</span><span class='line'>               imsi: &lt;redacted&gt;
</span><span class='line'>               uicc: &lt;redacted&gt;
</span><span class='line'>               rssi: -80dBm
</span><span class='line'>               rsrp: -106dBm
</span><span class='line'>               rsrq: -7dB
</span><span class='line'>               sinr: 18dB
</span></code></pre></td></tr></table></div></figure>


<p>One last thing we need to do is to persist this across (router or modem) reboots. For this we have to set a &lsquo;modem-init&rsquo; that gets excuted every time the modem is started.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/interface lte <span class="nb">set </span>lte1 modem-init<span class="o">=</span><span class="s2">&quot;AT^SYSCFGEX=\&quot;00\&quot;,3FFFFFFF,1,1,7FFFFFFFFFFFFFFF,,&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To verify</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>admin@MikroTik<span class="o">]</span> &gt; :put <span class="o">[</span>/interface lte get lte1 modem-init<span class="o">]</span>
</span><span class='line'>AT^SYSCFGEX<span class="o">=</span><span class="s2">&quot;00&quot;</span>,3FFFFFFF,1,1,7FFFFFFFFFFFFFFF,,
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
    <div id="ck_embed_form" class="ck_embed_form row">
  <div class="small-12 large-6 columns" id="ck_form_content">
    <h3 class="ck_embed_form_title">Get our Secrets of Successful Web Apps email course for free!</h3>
    <div class="ck_embed_description">
      <span class="ck_image">

      </span>
        <p>Sign up to get the lessons we&#8217;ve spent more than a decade learning straight to your inbox. 100% meat, no spam, ever.</p>
    </div>
  </div>
<div id='ck_success_msg' class='fade' style='display:none;'>
  <p>Thanks! Now check your email, confirm your subscription, and off we go!</p>
</div>
  <!--  Form starts here  -->
  <form id="ck_subscribe_form" class="small-12 large-6 columns" action="https://convertkit.com/app/landing_pages/259/subscribe">
    <input type="hidden" name="id" value="259" id="landing_page_id"></input>
    <p class="ck_errorArea"></p>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_firstNameField">First Name</label>
      <input type="text" name="first_name" class="ck_first_name" id="ck_firstNameField"></input>
    </div>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_emailField">Email Address</label>
        <input type="email" name="email" class="ck_email_address" id="ck_emailField"></input>
    </div>
    <label class="ck_checkbox">
      <input class="optIn ck_course_opted" type="checkbox" id="optIn" checked />
      I&#8217;d like to receive a free 30 day course by email.
    </label>

    <button class="subscribe_button ck_subscribe_button btn fields" id='ck_subscribe_button'>
      Claim my spot on the course
    </button>
    <span class="ck_guarantee">We won&#8217;t send you spam. Unsubscribe at any time.</span>
  </form>
</div>

<script src="https://convertkit.com/assets/CKJS4.js"></script>



  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/theden/getting-vagrant-vmware-plugin-installed-on-os-x-el-capitan-and-homebrew/">Getting Vagrant VMware Plugin Installed on OS X El Capitan and Homebrew</a></h1>
    
    
      <p class="meta">
        
  

<span class="byline author vcard"><span class="fn"><a href="/team/jarkko/" rel="author">Jarkko</a></span> wrote this on </span>

        




<time class='entry-date' datetime='2015-10-26T11:18:37+02:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:18 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I finally decided to bite the bullet this morning and install VMware Fusion 8 and the corresponding Vagrant plugin.</p>

<p>Both were paid upgrades (41.42€ + $39 from Fusion 7), which was a bit bitter given I had only had the previous versions for a couple of months. Yet, the word on the street was that the new version would be much more stable and less cpu-hungry than the previous generation. So what the heck, maybe I’d again be able to get more than a couple hours of productive work done without draining the battery.</p>

<p>The purchase process itself was painless, as was installing VMware itself. But when I started installing the plugin, an ugly yak raised its hairy head.</p>

<p>The first thing I tried was to just use the old plugin with the new VMware version. Would it perhaps work?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>➜  ~ vagrant <span class="nb">suspend</span>
</span><span class='line'>This provider only works with VMware Fusion 5.x, 6.x, or 7.x. You have
</span><span class='line'>Fusion <span class="s1">&#39;8.0.1&#39;</span>. Please install the proper version of VMware
</span><span class='line'>Fusion and try again.
</span></code></pre></td></tr></table></div></figure>


<p>That sounds like a resounding “No”.</p>

<p>So onwards: bought a license for the plugin as well and tried to install it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>➜  ~ vagrant plugin install vagrant-vmware-fusion
</span><span class='line'>Installing the <span class="s1">&#39;vagrant-vmware-fusion&#39;</span> plugin. This can take a few minutes...
</span><span class='line'>Bundler, the underlying system Vagrant uses to install plugins,
</span><span class='line'>reported an error. The error is shown below. These errors are usually
</span><span class='line'>caused by misconfigured plugin installations or transient network
</span><span class='line'>issues. The error from Bundler is:
</span><span class='line'>
</span><span class='line'>An error occurred <span class="k">while</span> installing hitimes <span class="o">(</span>1.2.3<span class="o">)</span>, and Bundler cannot <span class="k">continue</span>.
</span><span class='line'>Make sure that <span class="sb">`</span>gem install hitimes -v <span class="s1">&#39;1.2.3&#39;</span><span class="sb">`</span> succeeds before bundling.
</span><span class='line'>
</span><span class='line'>Gem::Installer::ExtensionBuildError: ERROR: Failed to build gem native extension.
</span><span class='line'>
</span><span class='line'>    /opt/vagrant/embedded/bin/ruby extconf.rb
</span><span class='line'>creating Makefile
</span><span class='line'>
</span><span class='line'>make <span class="s2">&quot;DESTDIR=&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Agreeing to the Xcode/iOS license requires admin privileges, please re-run as root via sudo.
</span></code></pre></td></tr></table></div></figure>


<p>No biggie, a little Googling revealed what I suspected – I don’t actually need to run this as root, I just need to accept the EULA of the latest XCode version before running the install process again. I popped up XCode, YOLOed the agreement, and was back to the terminal.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>➜  ~ vagrant plugin install vagrant-vmware-fusion
</span><span class='line'>Installing the <span class="s1">&#39;vagrant-vmware-fusion&#39;</span> plugin. This can take a few minutes...
</span><span class='line'>Bundler, the underlying system Vagrant uses to install plugins,
</span><span class='line'>reported an error. The error is shown below. These errors are usually
</span><span class='line'>caused by misconfigured plugin installations or transient network
</span><span class='line'>issues. The error from Bundler is:
</span><span class='line'>
</span><span class='line'>An error occurred <span class="k">while</span> installing eventmachine <span class="o">(</span>1.0.8<span class="o">)</span>, and Bundler cannot <span class="k">continue</span>.
</span><span class='line'>Make sure that <span class="sb">`</span>gem install eventmachine -v <span class="s1">&#39;1.0.8&#39;</span><span class="sb">`</span> succeeds before bundling.
</span><span class='line'>
</span><span class='line'>Gem::Installer::ExtensionBuildError: ERROR: Failed to build gem native extension.
</span><span class='line'>
</span><span class='line'><span class="o">[</span>LOTS OF CRUFT REMOVED FOR BREVITY<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>make <span class="s2">&quot;DESTDIR=&quot;</span>
</span><span class='line'>compiling binder.cpp
</span><span class='line'>warning: unknown warning option <span class="s1">&#39;-Werror=unused-command-line-argument-hard-error-in-future&#39;</span><span class="p">;</span> did you mean <span class="s1">&#39;-Werror=unused-command-line-argument&#39;</span>? <span class="o">[</span>-Wunknown-warning-option<span class="o">]</span>
</span><span class='line'>In file included from binder.cpp:20:
</span><span class='line'>./project.h:116:10: fatal error: <span class="s1">&#39;openssl/ssl.h&#39;</span> file not found
</span><span class='line'><span class="c">#include &lt;openssl/ssl.h&gt;</span>
</span><span class='line'>         ^
</span><span class='line'><span class="m">1</span> warning and <span class="m">1</span> error generated.
</span><span class='line'>make: *** <span class="o">[</span>binder.o<span class="o">]</span> Error 1
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>Gem files will remain installed in /Users/jarkko/.vagrant.d/gems/gems/eventmachine-1.0.8 <span class="k">for</span> inspection.
</span><span class='line'>Results logged to /Users/jarkko/.vagrant.d/gems/gems/eventmachine-1.0.8/ext/gem_make.out
</span></code></pre></td></tr></table></div></figure>


<p>Again, the reason is clear: I need to build the gem against proper openssl libs – in this case, <code>-I/usr/local/opt/openssl/include</code>. Thus:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>➜  ~  gem install eventmachine -v <span class="s1">&#39;1.0.8&#39;</span> -- --with-cppflags<span class="o">=</span>-I/usr/local/opt/openssl/include
</span><span class='line'>Fetching: eventmachine-1.0.8.gem <span class="o">(</span>100%<span class="o">)</span>
</span><span class='line'>Building native extensions with: <span class="s1">&#39;--with-cppflags=-I/usr/local/opt/openssl/include&#39;</span>
</span><span class='line'>This could take a <span class="k">while</span>...
</span><span class='line'>Successfully installed eventmachine-1.0.8
</span><span class='line'>Parsing documentation <span class="k">for</span> eventmachine-1.0.8
</span><span class='line'>Installing ri documentation <span class="k">for</span> eventmachine-1.0.8
</span><span class='line'>Done installing documentation <span class="k">for</span> eventmachine after <span class="m">6</span> seconds
</span><span class='line'><span class="m">1</span> gem installed
</span></code></pre></td></tr></table></div></figure>


<p>Perfect. So I tried to install the Vagrant plugin again – and got the same error. Crap.</p>

<p>It turns out that Vagrant uses its own gem folder, so it’s not picking up what’s installed in one’s primary gem directory. The issue was, how do I tell Vagrant to use the correct cpp flags in its build process?</p>

<p>Fortunately I didn’t have to figure that out, because the end of the error message above gave me enough of a pointer towards a solution: if I only managed to install the eventmachine gem by hand to the correct location with the proper cpp flags, I should be fine. But how?</p>

<p>I dug up to <code>gem -h</code> and the defaults at the end gave the correct option away: with the <code>--install-dir</code> option I could install the gem to wherever I wanted to. Thus:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>~  gem install eventmachine -v <span class="s1">&#39;1.0.8&#39;</span> --install-dir /Users/jarkko/.vagrant.d/gems  -- --with-cppflags<span class="o">=</span>-I/usr/local/opt/openssl/include
</span><span class='line'>Fetching: eventmachine-1.0.8.gem <span class="o">(</span>100%<span class="o">)</span>
</span><span class='line'>Building native extensions with: <span class="s1">&#39;--with-cppflags=-I/usr/local/opt/openssl/include&#39;</span>
</span><span class='line'>This could take a <span class="k">while</span>...
</span><span class='line'>Successfully installed eventmachine-1.0.8
</span><span class='line'>Parsing documentation <span class="k">for</span> eventmachine-1.0.8
</span><span class='line'>Installing ri documentation <span class="k">for</span> eventmachine-1.0.8
</span><span class='line'>Done installing documentation <span class="k">for</span> eventmachine after <span class="m">5</span> seconds
</span><span class='line'><span class="m">1</span> gem installed
</span></code></pre></td></tr></table></div></figure>


<p>Et voilá. Now one more try:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>➜    vagrant plugin install vagrant-vmware-fusion
</span><span class='line'>…
</span><span class='line'>Installed the plugin <span class="s1">&#39;vagrant-vmware-fusion (4.0.2)&#39;</span>!
</span></code></pre></td></tr></table></div></figure>


<p>…and we’re off to the races!</p>

<p>…well, at least almost.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>➜  ~ vagrant up
</span><span class='line'>Bringing machine <span class="s1">&#39;default&#39;</span> up with <span class="s1">&#39;vmware_fusion&#39;</span> provider...
</span><span class='line'><span class="o">==</span>&gt; default: Verifying vmnet devices are healthy...
</span><span class='line'><span class="o">==</span>&gt; default: Preparing network adapters...
</span><span class='line'><span class="o">==</span>&gt; default: Starting the VMware VM...
</span><span class='line'>An error occurred <span class="k">while</span> executing <span class="sb">`</span>vmrun<span class="sb">`</span>, a utility <span class="k">for</span> controlling
</span><span class='line'>VMware machines. The <span class="nb">command </span>and output are below:
</span><span class='line'>
</span><span class='line'>Command: <span class="o">[</span><span class="s2">&quot;start&quot;</span>, <span class="s2">&quot;/Users/jarkko/vmware/955a09a5-f7f6-451e-b565-22f41c8fced0/packer-ubuntu-14.04-amd64.vmx&quot;</span>, <span class="s2">&quot;nogui&quot;</span>, <span class="o">{</span>:notify<span class="o">=</span>&gt;<span class="o">[</span>:stdout, :stderr<span class="o">]</span>, :timeout<span class="o">=</span>&gt;45<span class="o">}]</span>
</span><span class='line'>
</span><span class='line'>Stdout: 2015-10-26T11:10:45.943<span class="p">|</span> ServiceImpl_Opener: PID 84443
</span><span class='line'>Error: The operation was canceled
</span><span class='line'>
</span><span class='line'>Stderr:
</span></code></pre></td></tr></table></div></figure>


<p>Oh well, that wasn’t very helpful. So I tried the proven trick #1: I killed the VMware app on OS X and even its menubar daemon just to be certain, and sure enough, it did the trick. The vagrant VM is now back on track.</p>
</div>
  
  


    </article>
    <div id="ck_embed_form" class="ck_embed_form row">
  <div class="small-12 large-6 columns" id="ck_form_content">
    <h3 class="ck_embed_form_title">Get our Secrets of Successful Web Apps email course for free!</h3>
    <div class="ck_embed_description">
      <span class="ck_image">

      </span>
        <p>Sign up to get the lessons we&#8217;ve spent more than a decade learning straight to your inbox. 100% meat, no spam, ever.</p>
    </div>
  </div>
<div id='ck_success_msg' class='fade' style='display:none;'>
  <p>Thanks! Now check your email, confirm your subscription, and off we go!</p>
</div>
  <!--  Form starts here  -->
  <form id="ck_subscribe_form" class="small-12 large-6 columns" action="https://convertkit.com/app/landing_pages/259/subscribe">
    <input type="hidden" name="id" value="259" id="landing_page_id"></input>
    <p class="ck_errorArea"></p>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_firstNameField">First Name</label>
      <input type="text" name="first_name" class="ck_first_name" id="ck_firstNameField"></input>
    </div>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_emailField">Email Address</label>
        <input type="email" name="email" class="ck_email_address" id="ck_emailField"></input>
    </div>
    <label class="ck_checkbox">
      <input class="optIn ck_course_opted" type="checkbox" id="optIn" checked />
      I&#8217;d like to receive a free 30 day course by email.
    </label>

    <button class="subscribe_button ck_subscribe_button btn fields" id='ck_subscribe_button'>
      Claim my spot on the course
    </button>
    <span class="ck_guarantee">We won&#8217;t send you spam. Unsubscribe at any time.</span>
  </form>
</div>

<script src="https://convertkit.com/assets/CKJS4.js"></script>



  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/theden/how-do-i-know-whether-my-rails-app-is-thread-safe-or-not/">How Do I Know Whether My Rails App Is Thread-safe or Not?</a></h1>
    
    
      <p class="meta">
        
  

<span class="byline author vcard"><span class="fn"><a href="/team/jarkko/" rel="author">Jarkko</a></span> wrote this on </span>

        




<time class='entry-date' datetime='2015-03-13T10:10:58+02:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>10:10 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure markdown="1">
  <a href="https://www.flickr.com/photos/digitalartform/3420918638/">
    <img src="https://farm4.staticflickr.com/3320/3420918638_36fb1505e5_b_d.jpg">
  </a>

  <figcaption>
    <p>
      Photo by <a href="https://www.flickr.com/photos/digitalartform/3420918638/">Joseph Francis</a>, used under a Creative Commons license.
    </p>
  </figcaption>
</figure>


<p>In January <a href="https://devcenter.heroku.com/changelog-items/594">Heroku started promoting</a> <a href="http://puma.io">Puma</a> as the preferred web server for Rails apps deployed on its hugely successful platform. Puma – as a threaded app server – can better use the scarce resources available for an app running on Heroku.</p>

<p>This is obviously good for a client since they can now run more concurrent users with a single Dyno. However, it’s also good for Heroku itself since small apps (probably the vast majority of apps deployed on Heroku) will now consume much fewer resources on its servers.</p>

<p>The recommendation comes with a caveat, however. <em>Your app needs to be thread-safe</em>. The problem with this is that there is no simple way to say with absolute certainty whether an app as a whole is thread-safe. We can get close, however.</p>

<p>Let’s have a look how.</p>

<p>For the purpose of this issue, an app can be split into three parts:</p>

<ol>
<li>The app code itself.</li>
<li>Rails the framework.</li>
<li>Any 3rd party gems used by the app.</li>
</ol>


<p>All three of these need to be thread-safe. Rails and its included gems <a href="http://m.onkey.org/thread-safety-for-your-rails">have been declared thread-safe since 2.2</a>, i.e. since 2008. This alone, however, does <em>not</em> automatically make your app as a whole so. Your own app code and all the gems you use need to be thread-safe as well.</p>

<h2>What is and what isn’t thread-safe in Ruby?</h2>

<p><strong>So when is your app code not thread-safe? Simply put, when you share mutable state between threads in your app.</strong></p>

<p>But what does this even mean?</p>

<p><strong>None of the core data structures (except for Queue) in Ruby are thread-safe</strong>. The structures are mutable, and when shared between threads, there are no guarantees the threads won’t overwrite each others’ changes. Fortunately, this is rarely the case in Rails apps.</p>

<p><strong>Any code that is more than a single operation (as in a single Ruby code call implemented in C) is not thread-safe.</strong> The classic example of this is the <code>+=</code> operator, which is in fact two operations combined, <code>=</code> and <code>+</code>. Thus, the final value of the shared variable in the following code is undetermined:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vi">@n</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="mi">3</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">Thread</span><span class="o">.</span><span class="n">start</span> <span class="p">{</span> <span class="mi">100</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="vi">@n</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, none of the two above things alone makes code thread-unsafe. It only becomes so when it is mated with shared data. Let’s get back to that in a minute, but first…</p>

<h2>Aside: <strong>But what about GIL?</strong></h2>

<p>More informed readers might object at this point and point out that MRI Ruby uses a GIL, a.k.a. Global Interpreter Lock.</p>

<p>The general wisdom on the street is that GIL is bad because it does not let your threads run in parallel (true, in a sense), but good, because it makes your code thread-safe.</p>

<p>Unfortunately, <strong>GIL <em>does not</em> make your code thread-safe</strong>. It only guarantees that two threads can’t run Ruby code at the same time. Thus it does inhibit parallelism. However, threads can still be paused and resumed at any given point, which means that they absolutely can clobber each others’ data.</p>

<p>GIL does accidentally make some operations (such as <code>Array#&lt;&lt;</code>) atomic. However, there are two issues with this:</p>

<ul>
<li>It only applies to cases where what you’re doing is truly a single Ruby operation. When what you’re doing is multiple operations, context switches can and will happen, and you won’t be happy.</li>
<li>It only applies to MRI. JRuby and Rubinius support true parallelism and thus don’t use a GIL. I wouldn’t count on GIL being there forever for MRI either, so relying on it guaranteeing your code being thread-safe is irresponsible at best.</li>
</ul>


<p>Go read Jesse Storimer’s <a href="http://www.jstorimer.com/blogs/workingwithcode/8085491-nobody-understands-the-gil">Nobody understands the GIL</a> (also parts <a href="http://www.jstorimer.com/blogs/workingwithcode/8100871-nobody-understands-the-gil-part-2-implementation">2</a> and <a href="http://www.rubyinside.com/does-the-gil-make-your-ruby-code-thread-safe-6051.html">3</a>) for much more detail about it (than you can probably even stomach). But for the love of the flying spaghetti monster, <em>don’t count on it making your app thread-safe</em>.</p>

<h2>Thread-safety in Rails the framework</h2>

<p>A bit of history:</p>

<p>Rails and its dependencies were declared thread-safe already in version 2.2, in 2008. At that point, however, the consensus was that so many third party libraries were not thread-safe that the whole request in Rails was enclosed within a giant mutex lock. This meant that while a request was being processed, no other thread in the same process could be running.</p>

<p>In order to take advantage of threaded execution, you had to declare in your config.rb that you really wanted to ditch the lock:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">threadsafe!</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, en route to Rails 4 <a href="http://tenderlovemaking.com/2012/06/18/removing-config-threadsafe.html">Aaron Tenderlove Patterson demonstrated</a> that what <code>config.threadsafe!</code> did was</p>

<ul>
<li>effectively irrelevant in multi-process environments (such as Unicorn), where a single process never processed multiple requests concurrently.</li>
<li>absolutely necessary every time you used a threaded server such as Puma or Passenger Enterprise.</li>
</ul>


<p>What this meant was that there was no reason for <em>not</em> to have the thread-safe option always on. And that was exactly what was done for Rails 4 in 2012.</p>

<p><strong>Key takeaway: Rails and its dependencies are thread-safe. You don’t have to do anything to “turn that feature on”.</strong></p>

<h2>Making your app code thread-safe</h2>

<p>Good news&colon; Since Rails uses the <a href="http://en.wikipedia.org/wiki/Shared_nothing_architecture">Shared nothing architecture</a>, Rails apps are consequentially very suitable for being thread-safe as well. In general, Rails creates a new controller object of every HTTP request, and everything else flows from there. This isolates most objects in a Rails app from other requests.</p>

<p>Like noted above, built-in Ruby data structures (save for Queue) are not thread-safe. This does not, however, matter, unless you are actually sharing them between threads. Because of the way in which Rails is architectured, this almost never happens in a Rails app.</p>

<p>There are, however, some patterns that can come bite you in the ass when you want to switch to a threaded app server.</p>

<h3>Global variables</h3>

<p>Global variables are, well, global. This means that they are shared between threads. If you weren’t convinced about not using global variables by now, here’s another reason to never touch them. If you really want to share something globally across an app, you are more than likely better served by a constant (but see below), anyway.</p>

<h3>Class variables</h3>

<p>For the purpose of a discussion about threads, class variables are not much different from global variables. They are shared across threads just the same way.</p>

<p>The problem isn’t so much about using class variables, but about mutating them. And if you are not going to mutate a class variable, in many cases a constant is again a better choice.</p>

<h3>Class instance variables</h3>

<p>But maybe you’ve read that you should always use class instance variables instead of class variables in Ruby. Well, maybe you should, but they are just as problematic for threaded programs as class variables.</p>

<p>It’s worth pointing out that both class variables and class instance variables can also be set by class methods. This isn’t such an issue in your own code, but you can easily fall into this trap when calling other apis. Here’s an <a href="http://m.onkey.org/thread-safety-for-your-rails">example from Pratik Naik</a> where the app developer is getting into thread-unsafe territory by just calling Rails class methods:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">HomeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">before_filter</span> <span class="ss">:set_site</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set_site</span>
</span><span class='line'>    <span class="vi">@site</span> <span class="o">=</span> <span class="no">Site</span><span class="o">.</span><span class="n">find_by_subdomain</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">subdomains</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@site</span><span class="o">.</span><span class="n">layout?</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">layout</span><span class="p">(</span><span class="vi">@site</span><span class="o">.</span><span class="n">layout_name</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">layout</span><span class="p">(</span><span class="s1">&#39;default_lay&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, calling the <code>layout</code> method causes Rails to set the class instance variable <code>@_layout</code> for the controller class. If two concurrent requests (served by two threads) hit this code simultaneously, they might end up in a race condition and overwrite each others’ layout.</p>

<p>In this case, the correct way to set the layout is to use a symbol with the layout call:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">HomeController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">before_filter</span> <span class="ss">:set_site</span>
</span><span class='line'>  <span class="n">layout</span> <span class="ss">:site_layout</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set_site</span>
</span><span class='line'>    <span class="vi">@site</span> <span class="o">=</span> <span class="no">Site</span><span class="o">.</span><span class="n">find_by_subdomain</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">subdomains</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">site_layout</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@site</span><span class="o">.</span><span class="n">layout?</span>
</span><span class='line'>      <span class="vi">@site</span><span class="o">.</span><span class="n">layout_name</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="s1">&#39;default_lay&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>However, this is besides the point. The point is, you might end up using class variables and class instance variables by accident, thus making your app thread-unsafe.</p>

<h3>Memoization</h3>

<p>Memoization is a technique where you lazily set a variable if it is not already set. It is a common technique used where the original functionality is at least moderately expensive and the resulting variable is used several times within a request.</p>

<p>A common case would be to set the current user in a controller:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SekritController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">before_filter</span> <span class="ss">:set_user</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set_user</span>
</span><span class='line'>    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Memoization by itself is not a thread safety issue. However, it can easily become one for a couple of reasons:</p>

<ul>
<li>It is often used to store data in class variables or class instance variables (see the previous points).</li>
<li>The <code>||=</code> operator is in fact two operations, so there is a potential context switch happening in the middle of it, causing a race condition between threads.</li>
</ul>


<p>It would be easy to dismiss memoization as the cause of the problem, and tell people just to avoid class variables and class instance variables. However, the issue is more complex than that.</p>

<p>In <a href="https://github.com/rails/rails/pull/9789">this issue</a>, Evan Phoenix squashes a really tricky race condition bug in the Rails codebase caused by calling <code>super</code> in a memoization function. So even though you would only be using instance variables, you might end up with race conditions with memoization.</p>

<p>What’s a developer to do, then?</p>

<ul>
<li>Make sure memoization makes sense and a difference in your case. In many cases Rails actually caches the result anyway, so that you are not saving a whole lot if any resources with your memoization method.</li>
<li>Don’t memoize to class variables or class instance variables. If you need to memoize something on the class level, use thread local variables (<code>Thread.current[:baz]</code>) instead. Be aware, though, that it is still kind of a global variable. So while it&rsquo;s thread-safe, it still might not be good coding practice.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">set_expensive_var</span>
</span><span class='line'>  <span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">[</span><span class="ss">:expensive_var</span><span class="o">]</span> <span class="o">||=</span> <span class="no">MyModel</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:goo_id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>If you absolutely think you must be able to share the result across threads, use a <a href="http://lucaguidi.com/2014/03/27/thread-safety-with-ruby.html">mutex</a> to synchronize the memoizing part of your code. Keep in mind, though, that you’re kinda breaking the Shared nothing model of Rails with that. It’s kind of a half-assed sharing method anyway, since it only works across threads, not across processes.</p>

<p>Also keep in mind, that a mutex only saves you from race conditions inside itself. It doesn&rsquo;t help you a whole lot with class variables unless you put the lock around the whole controller action, which was exactly what we wanted to avoid in the first place.</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">GooController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="vc">@@lock</span> <span class="o">=</span> <span class="no">Mutex</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>  <span class="n">before_filter</span> <span class="ss">:set_expensive_var</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set_expensive_var</span>
</span><span class='line'>    <span class="vc">@@lock</span><span class="o">.</span><span class="n">synchronize</span> <span class="k">do</span>
</span><span class='line'>      <span class="vc">@@stupid_class_var</span> <span class="o">||=</span> <span class="no">Foo</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:subdomain</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Use different instance variable names when you use inheritance and <code>super</code> in memoization methods.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Foo</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">env_config</span>
</span><span class='line'>    <span class="vi">@env_config</span> <span class="o">||=</span> <span class="p">{</span><span class="ss">foo</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="ss">bar</span><span class="p">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Bar</span> <span class="o">&lt;</span> <span class="no">Foo</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">env_config</span>
</span><span class='line'>    <span class="vi">@bar_env_config</span> <span class="o">||=</span> <span class="k">super</span><span class="o">.</span><span class="n">merge</span><span class="p">({</span><span class="ss">foo</span><span class="p">:</span> <span class="s1">&#39;baz&#39;</span><span class="p">})</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Constants</h3>

<p>Yes, constants. <em>You didn’t believe constants are really constant in Ruby, did you?</em> Well, they kinda are:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>irb<span class="o">(</span>main<span class="o">)</span>:008:0&gt; <span class="nv">CON</span>
</span><span class='line'><span class="o">=</span>&gt; <span class="o">[</span>1<span class="o">]</span>
</span><span class='line'>irb<span class="o">(</span>main<span class="o">)</span>:009:0&gt; <span class="nv">CON</span> <span class="o">=</span> <span class="o">[</span>1,2<span class="o">]</span>
</span><span class='line'><span class="o">(</span>irb<span class="o">)</span>:9: warning: already initialized constant CON
</span></code></pre></td></tr></table></div></figure>


<p>So you do get a warning when trying to reassign a constant, but the reassignment still goes through. That’s not the real problem, though. The real issue is that the constancy of constants only applies to the object reference, not the referenced object. And if the referenced object can be mutated, you have a problem.</p>

<p>Yeah, you remember right. <em>All the core data structures in Ruby are mutable</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>irb<span class="o">(</span>main<span class="o">)</span>:010:0&gt; <span class="nv">CON</span>
</span><span class='line'><span class="o">=</span>&gt; <span class="o">[</span>1, 2<span class="o">]</span>
</span><span class='line'>irb<span class="o">(</span>main<span class="o">)</span>:011:0&gt; CON <span class="s">&lt;&lt; 3</span>
</span><span class='line'><span class="s">=&gt; [1, 2, 3</span><span class="o">]</span>
</span><span class='line'>irb<span class="o">(</span>main<span class="o">)</span>:012:0&gt; <span class="nv">CON</span>
</span><span class='line'><span class="o">=</span>&gt; <span class="o">[</span>1, 2, 3<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, you should never, ever do this. And few will. There’s a catch, however. Since Ruby variable assignments also use references, you might end up mutating a constant by accident.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>irb<span class="o">(</span>main<span class="o">)</span>:010:0&gt; <span class="nv">CON</span>
</span><span class='line'><span class="o">=</span>&gt; <span class="o">[</span>1, 2<span class="o">]</span>
</span><span class='line'>irb<span class="o">(</span>main<span class="o">)</span>:011:0&gt; <span class="nv">arr</span> <span class="o">=</span> <span class="nv">CON</span>
</span><span class='line'><span class="o">=</span>&gt; <span class="o">[</span>1, 2<span class="o">]</span>
</span><span class='line'>irb<span class="o">(</span>main<span class="o">)</span>:012:0&gt; arr <span class="s">&lt;&lt; 3</span>
</span><span class='line'><span class="s">=&gt; [1, 2, 3</span><span class="o">]</span>
</span><span class='line'>irb<span class="o">(</span>main<span class="o">)</span>:013:0&gt; <span class="nv">CON</span>
</span><span class='line'><span class="o">=</span>&gt; <span class="o">[</span>1, 2, 3<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you want to be sure that your constants are never mutated, <a href="http://www.informit.com/articles/article.aspx?p=2251208&amp;seqNum=4">you can freeze</a> them upon creation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>irb<span class="o">(</span>main<span class="o">)</span>:001:0&gt; <span class="nv">CON</span> <span class="o">=</span> <span class="o">[</span>1,2,3<span class="o">]</span>.freeze
</span><span class='line'><span class="o">=</span>&gt; <span class="o">[</span>1, 2, 3<span class="o">]</span>
</span><span class='line'>irb<span class="o">(</span>main<span class="o">)</span>:002:0&gt; CON &lt;&lt; 4
</span><span class='line'>RuntimeError: can<span class="s1">&#39;t modify frozen Array</span>
</span><span class='line'><span class="s1">  from (irb):2</span>
</span><span class='line'><span class="s1">  from /Users/jarkko/.rbenv/versions/2.1.2/bin/irb:11:in `&lt;main&gt;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Keep in mind, though, that freeze is shallow. It only applies to the actual <code>Array</code> object in this case, not its items.</p>

<h3>Environment variables</h3>

<p><code>ENV</code> is really just a hash-like construct referenced by a constant. Thus, everything that applies to constants above, also applies to it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;version&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;1.2&quot;</span> <span class="c1"># Don&#39;t do this</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Making sure 3rd party code is thread-safe</h2>

<p>If you want your app to be thread-safe, all the third-party code it uses also needs to be thread-safe in the context of your app.</p>

<p>The first thing you probably should do with any gem is to read through its documentation and Google for whether it is deemed thread-safe. That said, even if it were, there’s no escaping double-checking yourself. Yes, by reading through the source code.</p>

<p>As a general rule, all that I wrote above about making your own code thread-safe applies here as well. However…</p>

<p><strong>With 3rd party gems and Rails plugins, context matters.</strong></p>

<p>If the third party code you use is just a library that your own code calls, you’re fairly safe (considering you’re using it in a thread-safe way yourself). It can be thread-unsafe just the same way as <code>Array</code> is, but if you don’t share the structures between threads, you’re more or less fine.</p>

<p>However, many Rails plugins actually extend or modify the Rails classes, in which case all bets are off. In this case, you need to scrutinize the library code much, much more thoroughly.</p>

<p>So how do you know which type of the two above a gem or plugin is? Well, you don’t. Until you read the code, that is. But you are reading the code anyway, aren’t you?</p>

<h3>What smells to look for in third party code?</h3>

<p>Everything we mentioned above regarding your own code applies.</p>

<ul>
<li>Class variables (<code>@@foo</code>)</li>
<li>Class instance variables (<code>@bar</code>, trickier to find since they look the same as any old ivar)</li>
<li>Constants, ENV variables, and potential variables through which they can be mutated.</li>
<li>Memoization, especially when one of the two above points are involved</li>
<li>Creation of new threads (<code>Thread.new</code>, <code>Thread.start</code>). These obviously aren’t smells just by themselves. However, the risks mentioned above only materialize when shared across threads, so you should at least be familiar with in which cases the library is spawning new threads.</li>
</ul>


<p>Again, context matters. Nothing above alone makes code thread-unsafe. Even sharing data with them doesn’t. But modifying that data does. So pay close attention to whether the libs provide methods that can be used to modify shared data.</p>

<h2>The final bad news</h2>

<p>No matter how thoroughly you read through the code in your application and the gems it uses, you cannot be 100% sure that the whole is thread-safe. Heck, even running and profiling the code in a test environment might not reveal lingering thread safety issues.</p>

<p>This is because many race conditions only appear under serious, concurrent load. That’s why you should both try to squash them from the code and keep a close eye on your production environment on a continual basis. Your app being perfectly thread-safe today does not guarantee the same is true a couple of sprints later.</p>

<h2>Recap</h2>

<p>To make a Rails app thread-safe, you have to make sure the code is thread-safe on three different levels:</p>

<ul>
<li>Rails framework and its dependencies.</li>
<li>Your app code.</li>
<li>Any third party code you use.</li>
</ul>


<p>The first one of these is handled for you, unless you do stupid shit with it (like the memoization example above). The rest is your responsibility.</p>

<p>The main thing to keep in mind is to never mutate data that is shared across threads. Most often this happens through class variables, class instance variables, or by accidentally mutating objects that are referenced by a constant.</p>

<p>There are, however, some pretty esoteric ways an app can end up thread-unsafe, so be prepared to track down and fix the last remaining threading issues while running in production.</p>

<p>Have fun!</p>

<p><em><strong>Acknowledgments</strong>: Thanks to <a href="https://twitter.com/raggi">James Tucker</a>, <a href="https://twitter.com/evanphx">Evan Phoenix</a>, and the whole <a href="https://bearmetal.eu/team/">Bear Metal gang</a> for providing feedback for the drafts of this article.</em></p>

<h3>Related articles</h3>

<p><em>This article is a part of a series about Rails performance optimization and GC tuning. Other articles in the series:</em></p>

<ul>
<li><a href="https://bearmetal.eu/theden/rails-garbage-collection-tuning-approaches/">Rails Garbage Collection: Tuning Approaches</a></li>
<li><a href="https://bearmetal.eu/theden/rails-garbage-collection-naive-defaults/">Rails Garbage Collection: Naive Defaults</a></li>
<li><a href="https://bearmetal.eu/theden/does-rails-scale/">Does Rails Scale?</a></li>
<li><a href="https://bearmetal.eu/theden/rails-garbage-collection-age-matters/">Rails Garbage Collection: Age Matters</a></li>
<li><a href="https://bearmetal.eu/theden/help-my-rails-app-is-melting-under-the-launch-day-load/">Help! My Rails App Is Melting Under the Launch Day Load</a></li>
</ul>

</div>
  
  


    </article>
    <div id="ck_embed_form" class="ck_embed_form row">
  <div class="small-12 large-6 columns" id="ck_form_content">
    <h3 class="ck_embed_form_title">Get our Secrets of Successful Web Apps email course for free!</h3>
    <div class="ck_embed_description">
      <span class="ck_image">

      </span>
        <p>Sign up to get the lessons we&#8217;ve spent more than a decade learning straight to your inbox. 100% meat, no spam, ever.</p>
    </div>
  </div>
<div id='ck_success_msg' class='fade' style='display:none;'>
  <p>Thanks! Now check your email, confirm your subscription, and off we go!</p>
</div>
  <!--  Form starts here  -->
  <form id="ck_subscribe_form" class="small-12 large-6 columns" action="https://convertkit.com/app/landing_pages/259/subscribe">
    <input type="hidden" name="id" value="259" id="landing_page_id"></input>
    <p class="ck_errorArea"></p>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_firstNameField">First Name</label>
      <input type="text" name="first_name" class="ck_first_name" id="ck_firstNameField"></input>
    </div>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_emailField">Email Address</label>
        <input type="email" name="email" class="ck_email_address" id="ck_emailField"></input>
    </div>
    <label class="ck_checkbox">
      <input class="optIn ck_course_opted" type="checkbox" id="optIn" checked />
      I&#8217;d like to receive a free 30 day course by email.
    </label>

    <button class="subscribe_button ck_subscribe_button btn fields" id='ck_subscribe_button'>
      Claim my spot on the course
    </button>
    <span class="ck_guarantee">We won&#8217;t send you spam. Unsubscribe at any time.</span>
  </form>
</div>

<script src="https://convertkit.com/assets/CKJS4.js"></script>



  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/theden/rails-garbage-collection-tuning-approaches/">Rails Garbage Collection: Tuning Approaches</a></h1>
    
    
      <p class="meta">
        
  

<span class="byline author vcard"><span class="fn"><a href="/team/lourens/" rel="author">Lourens</a></span> wrote this on </span>

        




<time class='entry-date' datetime='2015-02-20T09:19:02+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>20</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>9:19 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>MRI maintainers have put a tremendous amount of work into improving the garbage collector in Ruby 2.0 through 2.2. The engine has thus gained a lot more horsepower. However, it&rsquo;s still not trivial to get the most out of it. In this post we&rsquo;re going to gain a better understanding of how and what to tune for.</em></p>

<figure markdown="1">
  <a href="https://www.flickr.com/photos/stevoarnold/2862901152">
    <img src="https://farm3.staticflickr.com/2218/2862901152_b6b39592bd_o_d.jpg">
  </a>

  <figcaption>
    <p>
      Photo by <a href="https://www.flickr.com/photos/stevoarnold/2862901152">Steve Arnold</a>, used under a Creative Commons license.
    </p>
  </figcaption>
</figure>


<p>Koichi Sasada (_ko1, Ruby MRI maintainer) famously mentioned in a <a href="http://www.atdot.net/~ko1/activities/2014_rubyconf_ph_pub.pdf">presentation (slide 89)</a>:</p>

<blockquote><p> <strong>Try GC parameters</strong></p>

<ul>
<li>There is no silver bullet

<ul>
<li>No one answer for all applications</li>
<li>You should not believe other applications settings easily</li>
</ul>
</li>
<li>Try and try and try!</li>
</ul>
</blockquote>

<p>This is true in theory but a <em>whole lot harder</em> to pull off in practice due to three primary problems:</p>

<ul>
<li>Interpreter GC semantics and configuration change over time.</li>
<li>One GC config isn&rsquo;t optimal for all app runtime contexts: tests, requests, background jobs, rake tasks, etc.</li>
<li>During the lifetime and development cycles of a project, it&rsquo;s very likely that existing GC settings are invalidated quickly.</li>
</ul>


<h3>An evolving Garbage Collector</h3>

<p>The garbage collector has frequently changed in the latest MRI Ruby releases. The changes have also broken many existing assumptions and environment variables that tune the GC. Compare <code>GC.stat</code> on Ruby 2.1:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span> <span class="ss">:count</span><span class="o">=&gt;</span><span class="mi">7</span><span class="p">,</span> <span class="ss">:heap_used</span><span class="o">=&gt;</span><span class="mi">66</span><span class="p">,</span> <span class="ss">:heap_length</span><span class="o">=&gt;</span><span class="mi">66</span><span class="p">,</span> <span class="ss">:heap_increment</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:heap_live_slot</span><span class="o">=&gt;</span><span class="mi">26397</span><span class="p">,</span> <span class="ss">:heap_free_slot</span><span class="o">=&gt;</span><span class="mi">507</span><span class="p">,</span> <span class="ss">:heap_final_slot</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:heap_swept_slot</span><span class="o">=&gt;</span><span class="mi">10698</span><span class="p">,</span> <span class="ss">:heap_eden_page_length</span><span class="o">=&gt;</span><span class="mi">66</span><span class="p">,</span> <span class="ss">:heap_tomb_page_length</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:total_allocated_object</span><span class="o">=&gt;</span><span class="mi">75494</span><span class="p">,</span> <span class="ss">:total_freed_object</span><span class="o">=&gt;</span><span class="mi">49097</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:malloc_increase</span><span class="o">=&gt;</span><span class="mi">465840</span><span class="p">,</span> <span class="ss">:malloc_limit</span><span class="o">=&gt;</span><span class="mi">16777216</span><span class="p">,</span> <span class="ss">:minor_gc_count</span><span class="o">=&gt;</span><span class="mi">5</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:major_gc_count</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:remembered_shady_object</span><span class="o">=&gt;</span><span class="mi">175</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:remembered_shady_object_limit</span><span class="o">=&gt;</span><span class="mi">322</span><span class="p">,</span> <span class="ss">:old_object</span><span class="o">=&gt;</span><span class="mi">9109</span><span class="p">,</span> <span class="ss">:old_object_limit</span><span class="o">=&gt;</span><span class="mi">15116</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:oldmalloc_increase</span><span class="o">=&gt;</span><span class="mi">1136080</span><span class="p">,</span> <span class="ss">:oldmalloc_limit</span><span class="o">=&gt;</span><span class="mi">16777216</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>…with Ruby 2.2:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span> <span class="ss">:count</span><span class="o">=&gt;</span><span class="mi">6</span><span class="p">,</span> <span class="ss">:heap_allocated_pages</span><span class="o">=&gt;</span><span class="mi">74</span><span class="p">,</span> <span class="ss">:heap_sorted_length</span><span class="o">=&gt;</span><span class="mi">75</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:heap_allocatable_pages</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="ss">:heap_available_slots</span><span class="o">=&gt;</span><span class="mi">30162</span><span class="p">,</span> <span class="ss">:heap_live_slots</span><span class="o">=&gt;</span><span class="mi">29729</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:heap_free_slots</span><span class="o">=&gt;</span><span class="mi">433</span><span class="p">,</span> <span class="ss">:heap_final_slots</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="ss">:heap_marked_slots</span><span class="o">=&gt;</span><span class="mi">14752</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:heap_swept_slots</span><span class="o">=&gt;</span><span class="mi">11520</span><span class="p">,</span> <span class="ss">:heap_eden_pages</span><span class="o">=&gt;</span><span class="mi">74</span><span class="p">,</span> <span class="ss">:heap_tomb_pages</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:total_allocated_pages</span><span class="o">=&gt;</span><span class="mi">74</span><span class="p">,</span> <span class="ss">:total_freed_pages</span><span class="o">=&gt;</span><span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:total_allocated_objects</span><span class="o">=&gt;</span><span class="mi">76976</span><span class="p">,</span> <span class="ss">:total_freed_objects</span><span class="o">=&gt;</span><span class="mi">47247</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:malloc_increase_bytes</span><span class="o">=&gt;</span><span class="mi">449520</span><span class="p">,</span> <span class="ss">:malloc_increase_bytes_limit</span><span class="o">=&gt;</span><span class="mi">16777216</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:minor_gc_count</span><span class="o">=&gt;</span><span class="mi">4</span><span class="p">,</span> <span class="ss">:major_gc_count</span><span class="o">=&gt;</span><span class="mi">2</span><span class="p">,</span> <span class="ss">:remembered_wb_unprotected_objects</span><span class="o">=&gt;</span><span class="mi">169</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:remembered_wb_unprotected_objects_limit</span><span class="o">=&gt;</span><span class="mi">278</span><span class="p">,</span> <span class="ss">:old_objects</span><span class="o">=&gt;</span><span class="mi">9337</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:old_objects_limit</span><span class="o">=&gt;</span><span class="mi">10806</span><span class="p">,</span> <span class="ss">:oldmalloc_increase_bytes</span><span class="o">=&gt;</span><span class="mi">1147760</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:oldmalloc_increase_bytes_limit</span><span class="o">=&gt;</span><span class="mi">16777216</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Ruby 2.2 we can see a lot more to introspect and tune, but this also comes with a steep learning curve which is (and should be) out of scope for most developers.</p>

<h3>One codebase, different roles</h3>

<p>A modern Rails application is typically used day to day in different contexts:</p>

<ul>
<li>Running tests</li>
<li>rake tasks</li>
<li>database migrations</li>
<li>background jobs</li>
</ul>


<p>They all start pretty much the same way with the VM compiling code to instruction sequences. Different roles affect the Ruby heap and the garbage collector in very different ways, however.</p>

<p>This job typically runs for 13 minutes, triggers 133 GC cycles and allocates a metric ton of objects. Allocations are very bursty and in batches.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CartCleanupJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">queue_as</span> <span class="ss">:default</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="no">Cart</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This controller action allocates 24 555 objects. Allocator throughput isn&rsquo;t very variable.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">CartsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">show</span>
</span><span class='line'>    <span class="vi">@cart</span> <span class="o">=</span> <span class="no">Cart</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our test case contributes 175 objects to the heap. Test cases generally are very variable and bursty in allocation patterns.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">test_add_to_cart</span>
</span><span class='line'>  <span class="n">cart</span> <span class="o">=</span> <span class="n">carts</span><span class="p">(</span><span class="ss">:empty</span><span class="p">)</span>
</span><span class='line'>  <span class="n">cart</span> <span class="o">&lt;&lt;</span> <span class="n">products</span><span class="p">(</span><span class="ss">:butter</span><span class="p">)</span>
</span><span class='line'>  <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cart</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">size</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The default GC behavior isn&rsquo;t optimal for all of these execution paths within the same project and neither is <a href="http://www.reddit.com/r/ruby/comments/2m663d/ruby_21_gc_settings">throwing</a> a single set of <code>RUBY_GC_*</code> environment variables at it.</p>

<p>We&rsquo;d like to refer to processing in these different contexts as &ldquo;units of work&rdquo;.</p>

<h3>Fast development cycles</h3>

<p>During the lifetime and development cycle of a project, it&rsquo;s very likely that garbage collector settings that were valid yesterday aren&rsquo;t optimal anymore after the next two sprints. Changes to your Gemfile, rolling out new features, and bumping the Ruby interpreter all affect the garbage collector.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">ruby</span> <span class="s1">&#39;2.2.0&#39;</span> <span class="c1"># Invalidates most existing RUBY_GC_* variables</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;mail&#39;</span> <span class="c1"># slots galore</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Process lifecycle events</h2>

<p>Let&rsquo;s have a look at a few events that are important during the lifetime of a process. They help the tuner to gain valuable insights into how well the garbage collector is working and how to further optimize it. They all hint at how the heap changes and what triggered a GC cycle.</p>

<p>How many mutations happened for example while</p>

<ul>
<li>processing a request</li>
<li>between booting the app and processing a request</li>
<li>during the lifetime of the application?</li>
</ul>


<h3>When it booted</h3>

<p><em>When the application is ready to start doing work.</em> For Rails application, this is typically when the app has been fully loaded in production, ready to serve requests, ready to accept background work, etc. All source files have been loaded and most resources acquired.</p>

<h3>When processing started</h3>

<p><em>At the start of a unit of work.</em> Typically the start of an HTTP request, when a background job has been popped off a queue, the start of a test case or any other type of processing that is the primary purpose of running the process.</p>

<h3>When processing ended</h3>

<p><em>At the end of a unit of work.</em> Typically the end of a HTTP request, when a background job has finished processing, the end of a test case or any other type of processing that is the primary purpose of running the process.</p>

<h3>When it terminated</h3>

<p>Triggered when the application terminates.</p>

<h2>Knowing when and why GC happens</h2>

<p>Tracking GC cycles interleaved with the aforementioned application events yield insights into why a particular GC cycle happens. The progression from BOOTED to TERMINATED and everything else is important because mutations that happen during the fifth HTTP request of a new Rails process also contribute to a GC cycle during request number eight.</p>

<h2>On tuning</h2>

<p>Primarily the garbage collector exposes tuning variables in these three categories:</p>

<ul>
<li>Heap slot values: where Ruby objects live</li>
<li>Malloc limits: off heap storage for large strings, arrays and other structures</li>
<li>Growth factors: by how much to grow slots, malloc limits etc.</li>
</ul>


<p>Tuning GC parameters is generally a tradeoff between tuning for speed (thus using more memory) and tuning for low memory usage while giving up speed. We think it&rsquo;s possible to infer a reasonable set of defaults from observing the application at runtime that&rsquo;s conservative with memory, yet maintain reasonable throughput.</p>

<h2>A solution</h2>

<p>We&rsquo;ve been working on a product, <a href="https://tunemygc.com">TuneMyGC</a> for a few weeks that attempts to do just that. Our goals and objectives are:</p>

<ul>
<li>A repeatable and systematic tuning process that respects fast development cycles</li>
<li>It should have awareness of runtime profiles being different for HTTP requests, background job processing etc.</li>
<li>It should support current mainline Ruby versions without developers having to keep up to date with changes</li>
<li>Deliver reasonable memory footprints with better runtime performance</li>
<li>Provide better insights into GC characteristics both for app owners and possibly also ruby-core</li>
</ul>


<p>Here&rsquo;s an example of <a href="http://www.discourse.org">Discourse</a> being automatically tuned for better 99th percentile throughput. Response times in milliseconds, 200 requests:</p>

<table>
<thead>
<tr>
<th> <em>Controller</em>  </th>
<th> <em><a href="https://tunemygc.com/configs/c5214cfa00b3bf429badd2161c4b6a08">GC defaults</a></em> </th>
<th> <em><a href="https://tunemygc.com/configs/e129791f94159a8c75bef3a636c05798">Tuned GC</a></em> </th>
</tr>
</thead>
<tbody>
<tr>
<td> categories  </td>
<td>     227      </td>
<td>    160         </td>
</tr>
<tr>
<td> home        </td>
<td>     163      </td>
<td>    113         </td>
</tr>
<tr>
<td> topic       </td>
<td>     55       </td>
<td>    40          </td>
</tr>
<tr>
<td> user        </td>
<td>     92       </td>
<td>    76          </td>
</tr>
</tbody>
</table>


<h4><a href="https://tunemygc.com/configs/c5214cfa00b3bf429badd2161c4b6a08">GC defaults</a>:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ RUBY_GC_TUNE</span><span class="o">=</span><span class="m">1</span> <span class="nv">RUBY_GC_TOKEN</span><span class="o">=</span>a5a672761b25265ec62a1140e21fc81f ruby script/bench.rb -m -i 200
</span></code></pre></td></tr></table></div></figure>


<p>Raw GC stats from Discourse&rsquo;s bench.rb script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>GC STATS:
</span><span class='line'>count: 106
</span><span class='line'>heap_allocated_pages: 2447
</span><span class='line'>heap_sorted_length: 2455
</span><span class='line'>heap_allocatable_pages: 95
</span><span class='line'>heap_available_slots: 997407
</span><span class='line'>heap_live_slots: 464541
</span><span class='line'>heap_free_slots: 532866
</span><span class='line'>heap_final_slots: 0
</span><span class='line'>heap_marked_slots: 464530
</span><span class='line'>heap_swept_slots: 532876
</span><span class='line'>heap_eden_pages: 2352
</span><span class='line'>heap_tomb_pages: 95
</span><span class='line'>total_allocated_pages: 2447
</span><span class='line'>total_freed_pages: 0
</span><span class='line'>total_allocated_objects: 27169276
</span><span class='line'>total_freed_objects: 26704735
</span><span class='line'>malloc_increase_bytes: 4352
</span><span class='line'>malloc_increase_bytes_limit: 16777216
</span><span class='line'>minor_gc_count: 91
</span><span class='line'>major_gc_count: 15
</span><span class='line'>remembered_wb_unprotected_objects: 11669
</span><span class='line'>remembered_wb_unprotected_objects_limit: 23338
</span><span class='line'>old_objects: 435435
</span><span class='line'>old_objects_limit: 870870
</span><span class='line'>oldmalloc_increase_bytes: 4736
</span><span class='line'>oldmalloc_increase_bytes_limit: <span class="m">30286118</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a href="https://tunemygc.com/configs/e129791f94159a8c75bef3a636c05798">TuneMyGC recommendations</a></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ RUBY_GC_TUNE</span><span class="o">=</span><span class="m">1</span> <span class="nv">RUBY_GC_TOKEN</span><span class="o">=</span>a5a672761b25265ec62a1140e21fc81f <span class="nv">RUBY_GC_HEAP_INIT_SLOTS</span><span class="o">=</span><span class="m">997339</span> <span class="nv">RUBY_GC_HEAP_FREE_SLOTS</span><span class="o">=</span><span class="m">626600</span> <span class="nv">RUBY_GC_HEAP_GROWTH_FACTOR</span><span class="o">=</span>1.03 <span class="nv">RUBY_GC_HEAP_GROWTH_MAX_SLOTS</span><span class="o">=</span><span class="m">88792</span> <span class="nv">RUBY_GC_HEAP_OLDOBJECT_LIMIT_FACTOR</span><span class="o">=</span>2.4 <span class="nv">RUBY_GC_MALLOC_LIMIT</span><span class="o">=</span><span class="m">34393793</span> <span class="nv">RUBY_GC_MALLOC_LIMIT_MAX</span><span class="o">=</span><span class="m">41272552</span> <span class="nv">RUBY_GC_MALLOC_LIMIT_GROWTH_FACTOR</span><span class="o">=</span>1.32 <span class="nv">RUBY_GC_OLDMALLOC_LIMIT</span><span class="o">=</span><span class="m">39339204</span> <span class="nv">RUBY_GC_OLDMALLOC_LIMIT_MAX</span><span class="o">=</span><span class="m">47207045</span> <span class="nv">RUBY_GC_OLDMALLOC_LIMIT_GROWTH_FACTOR</span><span class="o">=</span>1.2 ruby script/bench.rb -m -i 200
</span></code></pre></td></tr></table></div></figure>


<p>Raw GC stats from Discourse&rsquo;s bench.rb script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>GC STATS:
</span><span class='line'>count: 44
</span><span class='line'>heap_allocated_pages: 2893
</span><span class='line'>heap_sorted_length: 2953
</span><span class='line'>heap_allocatable_pages: 161
</span><span class='line'>heap_available_slots: 1179182
</span><span class='line'>heap_live_slots: 460935
</span><span class='line'>heap_free_slots: 718247
</span><span class='line'>heap_final_slots: 0
</span><span class='line'>heap_marked_slots: 460925
</span><span class='line'>heap_swept_slots: 718277
</span><span class='line'>heap_eden_pages: 2732
</span><span class='line'>heap_tomb_pages: 161
</span><span class='line'>total_allocated_pages: 2893
</span><span class='line'>total_freed_pages: 0
</span><span class='line'>total_allocated_objects: 27167493
</span><span class='line'>total_freed_objects: 26706558
</span><span class='line'>malloc_increase_bytes: 4352
</span><span class='line'>malloc_increase_bytes_limit: 34393793
</span><span class='line'>minor_gc_count: 34
</span><span class='line'>major_gc_count: 10
</span><span class='line'>remembered_wb_unprotected_objects: 11659
</span><span class='line'>remembered_wb_unprotected_objects_limit: 27981
</span><span class='line'>old_objects: 431838
</span><span class='line'>old_objects_limit: 1036411
</span><span class='line'>oldmalloc_increase_bytes: 4736
</span><span class='line'>oldmalloc_increase_bytes_limit: 39339204
</span></code></pre></td></tr></table></div></figure>


<p>We can see a couple of interesting points here:</p>

<ul>
<li>There is much less GC activity – only 44 rounds instead of 106.</li>
<li>Slot buffers are still decent for high throughput. There are 718247 free slots (<code>heap_free_slots</code>) of 1179182 available slots (<code>heap_available_slots</code>), which is 64% of the current live objects (<code>heap_live_slots</code>). This value however is slightly skewed because the <a href="http://www.discourse.org">Discourse</a> benchmark script forces a major GC before dumping these stats - there are about as many swept slots as free slots (<code>heap_swept_slots</code>).</li>
<li>Malloc limits (<code>malloc_increase_bytes_limit</code> and <code>oldmalloc_increase_bytes_limit</code>) and growth factors (<code>old_objects_limit</code> and <code>remembered_wb_unprotected_objects_limit</code>) are in line with actual app usage. The TuneMyGC service considers when limits and growth factors are bumped during the app lifecycle and attempts to raise limits via environment variables slightly higher to prevent excessive GC activity.</li>
</ul>


<p>Now it&rsquo;s your turn.</p>

<h2>Feel free to take your Rails app for a spin too!</h2>

<h3>1. Add to your Gemfile.</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem <span class="s1">&#39;tunemygc&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. Register your Rails application.</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle <span class="nb">exec </span>tunemygc -r email@yourdomain.com
</span><span class='line'>      Application registered. Use <span class="nv">RUBY_GC_TOKEN</span><span class="o">=</span>08de9e8822c847244b31290cedfc1d51 in your environment.
</span></code></pre></td></tr></table></div></figure>


<h3>3. Boot your app. We recommend an optimal GC configuration when it ends</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ RUBY_GC_TOKEN</span><span class="o">=</span>08de9e8822c847244b31290cedfc1d51 <span class="nv">RUBY_GC_TUNE</span><span class="o">=</span><span class="m">1</span> bundle <span class="nb">exec </span>rails s
</span></code></pre></td></tr></table></div></figure>


<h2>Related articles</h2>

<p><em>This article is a part of a series about Rails performance optimization and GC tuning. Other articles in the series:</em></p>

<ul>
<li><a href="https://bearmetal.eu/theden/rails-garbage-collection-naive-defaults/">Rails Garbage Collection: Naive Defaults</a></li>
<li><a href="https://bearmetal.eu/theden/does-rails-scale/">Does Rails Scale?</a></li>
<li><a href="https://bearmetal.eu/theden/rails-garbage-collection-age-matters/">Rails Garbage Collection: Age Matters</a></li>
<li><a href="https://bearmetal.eu/theden/help-my-rails-app-is-melting-under-the-launch-day-load/">Help! My Rails App Is Melting Under the Launch Day Load</a></li>
<li><a href="https://bearmetal.eu/theden/how-do-i-know-whether-my-rails-app-is-thread-safe-or-not/">How Do I Know Whether My Rails App Is Thread-safe or Not?</a></li>
</ul>

</div>
  
  


    </article>
    <div id="ck_embed_form" class="ck_embed_form row">
  <div class="small-12 large-6 columns" id="ck_form_content">
    <h3 class="ck_embed_form_title">Get our Secrets of Successful Web Apps email course for free!</h3>
    <div class="ck_embed_description">
      <span class="ck_image">

      </span>
        <p>Sign up to get the lessons we&#8217;ve spent more than a decade learning straight to your inbox. 100% meat, no spam, ever.</p>
    </div>
  </div>
<div id='ck_success_msg' class='fade' style='display:none;'>
  <p>Thanks! Now check your email, confirm your subscription, and off we go!</p>
</div>
  <!--  Form starts here  -->
  <form id="ck_subscribe_form" class="small-12 large-6 columns" action="https://convertkit.com/app/landing_pages/259/subscribe">
    <input type="hidden" name="id" value="259" id="landing_page_id"></input>
    <p class="ck_errorArea"></p>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_firstNameField">First Name</label>
      <input type="text" name="first_name" class="ck_first_name" id="ck_firstNameField"></input>
    </div>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_emailField">Email Address</label>
        <input type="email" name="email" class="ck_email_address" id="ck_emailField"></input>
    </div>
    <label class="ck_checkbox">
      <input class="optIn ck_course_opted" type="checkbox" id="optIn" checked />
      I&#8217;d like to receive a free 30 day course by email.
    </label>

    <button class="subscribe_button ck_subscribe_button btn fields" id='ck_subscribe_button'>
      Claim my spot on the course
    </button>
    <span class="ck_guarantee">We won&#8217;t send you spam. Unsubscribe at any time.</span>
  </form>
</div>

<script src="https://convertkit.com/assets/CKJS4.js"></script>



  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/theden/its-not-about-you/">It&#8217;s Not About You</a></h1>
    
    
      <p class="meta">
        
  

<span class="byline author vcard"><span class="fn"><a href="/team/jarkko/" rel="author">Jarkko</a></span> wrote this on </span>

        




<time class='entry-date' datetime='2015-02-12T13:32:39+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:32 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><em>This is a slightly expanded version of a talk I gave in <a href="http://railsgirls.com/helsinki">Rails Girls Helsinki</a> in February 2015.</em></p>

<figure markdown="1">
  <a href="https://www.flickr.com/photos/smemon/11984559914/">
    <img src="https://farm4.staticflickr.com/3728/11984559914_be77fb9031_o_d.png">
  </a>

  <figcaption>
    <p>
      Photo by <a href="https://www.flickr.com/photos/smemon/11984559914/">Sean MacEntee</a>, used under a Creative Commons license.
    </p>
  </figcaption>
</figure>


<p>I used to suffer from terrible stage fright. I was super nervous every time I presented. I forgot stuff I was supposed to say on stage. I never vomited before a talk, though, I’ll give you that.</p>

<p>It got better over time through lots of practice, but I still get all sweaty and shaky before getting on stage.</p>

<p>Then I recently stumbled upon an article by Kathy Sierra called <a href="http://seriouspony.com/blog/2013/10/4/presentation-skills-considered-harmful">Presentation Skills Considered Harmful</a>. In it she tells about having had similar problems, and how all the tutorials told her what and how you should do to give a good presentation. You, you, you.</p>

<p>Then she realized that a presentation is really a UX. <em>A presentation is just a user experience</em>. You present ideas – hopefully good ones – to your audience. What does this make you, the presenter? A UI. You are just a UI, a user interface. <em>You</em> yourself don’t matter that much. All that matters is that your ideas touch your audience.</p>

<p>Is that bad? No, it’s great. It’s a huge relief. What matters is  not you but what you have to say, the meat of your talk.</p>

<p>And that brings us nicely to the topic of this article.</p>

<p><strong>It’s not about you.</strong></p>

<p>This is maybe the most important thing I’ve learned during the past decade<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>. It’s also not only profound, but spans your entire life.</p>

<h2>Writing</h2>

<p>These days, everyone and their cat has a blog.</p>

<p>Most blogs tell about the author, which is totally fine — if the author writes it for themselves or their relatives. But when you think about the most helpful blogs – the ones you go back to all the time – they really aren’t. They are about helping the reader, either by informing them or teaching them new things.</p>

<p><em>But Jarkko</em>, I hear you say. <em>You just started this article with a story about yourself</em>.</p>

<p>That is correct. Storytelling gets kind of an exception.</p>

<p>Except not really. Because storytelling isn’t really about the storyteller, either. You know, we didn’t always know how to write. Telling stories was the only way to pass information to younger generations. Thus, our brains are quite literally wired to react to storytelling. <a href="http://lifehacker.com/5965703/the-science-of-storytelling-why-telling-a-story-is-the-most-powerful-way-to-activate-our-brains">We’re evolutionarily built to learn better from stories</a>.</p>

<p>Thus, stories are not so much about you, the teller, either. Stories are about the listener/reader, and how they relate to the protagonist of the narrative.</p>

<p>And in the end, unless you’re writing fiction, stories are just a tool as well. A powerful one, yes, but just a tool to bring home a lesson to the reader.</p>

<p><em>Because writing is not about you.</em></p>

<p>Cincinnati Enquirer learned this the hard way recently. After they laid off their whole copy desk, they were <em>shocked</em> to find out that readers were outraged about the deteriorating quality of the paper’s articles. John E. McIntyre <a href="http://www.baltimoresun.com/news/language-blog/bal-first-lesson-nobody-cares-20150211-story.html">describes the issue</a> vividly:</p>

<blockquote><p>The reader doesn’t care how hard you worked, what pressures you are under, or how good your intentions are. The reader sees the product, online or in print; if the product looks sloppy and substandard, the reader will form, and likely express, a low opinion of it. And the reader is under no obligation whatsoever to be kind.</p></blockquote>

<p>What the Enquirer forgot was that <em>their writing is really not about them</em>.</p>

<p>But you don’t wanna hear me babble about writing, let’s get to business.</p>

<h2>Business ideas</h2>

<p>Are you still looking for that killer business idea?</p>

<p>Stop.</p>

<p>Ideas are all about you. How to get into business <em>you</em> should – apparently through divine intervention or something – come up with a dazzling idea.</p>

<p><a href="https://unicornfree.com/2013/how-do-you-create-a-product-people-want-to-buy">Ideas are also dangerous</a> because once you get one, it makes you a victim of <a href="http://en.wikipedia.org/wiki/Confirmation_bias">confirmation bias</a>. You’re going to start retrofitting the world to your idea, which is totally backwards.</p>

<p>Instead, find an audience you can relate to and sell to. Then, find about their pains, problems, and ways to help them make more money. Then solve that pain and you’ll do well.</p>

<p>Because – to quote Peter Drucker – the purpose of business is to create and keep a customer. It’s that customer, not you, who is going to decide the fate of your business.</p>

<p><em>Because successful business isn’t about you.</em></p>

<h2>Marketing</h2>

<p>You know what’s special about Apple ads? They almost never list features or specs. Instead, they show what their users can do with them. Shoot video. <em>Facetime</em> with their relatives on the other side of globe. Throw a DJ gig with just an iPad or two.</p>

<p>My friend Amy Hoy has this formula for great sales copy called <a href="https://unicornfree.com/2013/how-i-increased-conversion-2-4x-with-better-copywriting">PDF, for Pain–Dream–Fix</a>:</p>

<ol>
<li>Start with describing the pain your users are having, with crisp, clear words, so that they will go all <em>ahhh, they understand me</em>.</li>
<li>Then flip it around.
 <em>“Imagine a world where you wouldn’t have to manually scan your taxi receipts. Instead, they would magically appear in your accounting system.”</em></li>
<li>And fix.
 <em>“We got you covered. Uberreceipt 9000 will hook up Uber with your accounting and you will never again touch another taxi receipt!”</em></li>
</ol>


<p>Now <em>that</em> is how you make people pay attention.</p>

<p>Because <em>great marketing and sales copy is not about you</em>, either.</p>

<h2>Finally: Product</h2>

<p>Last, and indeed least, we get to the actual product, software in our case.</p>

<p><em>It – as and of itself – is not all that important</em>. Because having a great product is not about you, or the product itself. It’s about solving a customer pain or a job they need to tackle.</p>

<p>Because people don’t buy a quarter-inch drill, they buy a quarter-inch hole in the wall.</p>

<p>By now, you already know the pains of your audience<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>. Now it’s time to solve them. From previous points, you should already have a nice roadmap to a product people like.</p>

<h2>Extra credit: Make your users kick ass</h2>

<p>For an extra credit, let’s see how we could transform people from liking your product to loving and raving about it.</p>

<p>We started this talk with Kathy Sierra, and we’re going to end it with her as well.</p>

<p>Kathy’s <a href="http://businessofsoftware.org/2013/02/kathy-sierra-building-the-minimum-badass-user-business-of-software-a-masterclass-in-thinking-about-software-product-development/">big idea</a> is that the main purpose of software is to make its users kick ass. What she means by this is that software – or any product really – should help their users to get better at what they do, not just using the product<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>.</p>

<p><em>Screw gamification.</em></p>

<p>Final Cut Pro should not make its users better at using Final Cut Pro. <em>It should make them better film editors.</em></p>

<p><a href="https://www.wodconnect.com">WODConnect</a> should not make its users better at using the app. <em>It should make them stronger and faster.</em></p>

<p>This should happen through <em>everything</em> related to your product. The product itself, its marketing, its manuals, its customer support, everything.</p>

<p>Because your success is not about you or your product.</p>

<p>It’s about the users.</p>

<p>It’s about empathy.</p>

<hr />

<p>Discuss on <a href="https://news.ycombinator.com/item?id=9038804">Hacker News</a>.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Well, let’s just say it’s a tie with learning about the <a href="http://mindsetonline.com">growth mindset</a>.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>If not, go back to the Business Ideas part above. Do not  – and I can’t stress this enough – start building a product before you are sure it solves a problem people have, know they have, and are willing to pay for.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p>All this is also the subject of Kathy’s upcoming book, <a href="http://shop.oreilly.com/product/0636920036593.do">Badass: Making Users Awesome</a><a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
    <div id="ck_embed_form" class="ck_embed_form row">
  <div class="small-12 large-6 columns" id="ck_form_content">
    <h3 class="ck_embed_form_title">Get our Secrets of Successful Web Apps email course for free!</h3>
    <div class="ck_embed_description">
      <span class="ck_image">

      </span>
        <p>Sign up to get the lessons we&#8217;ve spent more than a decade learning straight to your inbox. 100% meat, no spam, ever.</p>
    </div>
  </div>
<div id='ck_success_msg' class='fade' style='display:none;'>
  <p>Thanks! Now check your email, confirm your subscription, and off we go!</p>
</div>
  <!--  Form starts here  -->
  <form id="ck_subscribe_form" class="small-12 large-6 columns" action="https://convertkit.com/app/landing_pages/259/subscribe">
    <input type="hidden" name="id" value="259" id="landing_page_id"></input>
    <p class="ck_errorArea"></p>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_firstNameField">First Name</label>
      <input type="text" name="first_name" class="ck_first_name" id="ck_firstNameField"></input>
    </div>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_emailField">Email Address</label>
        <input type="email" name="email" class="ck_email_address" id="ck_emailField"></input>
    </div>
    <label class="ck_checkbox">
      <input class="optIn ck_course_opted" type="checkbox" id="optIn" checked />
      I&#8217;d like to receive a free 30 day course by email.
    </label>

    <button class="subscribe_button ck_subscribe_button btn fields" id='ck_subscribe_button'>
      Claim my spot on the course
    </button>
    <span class="ck_guarantee">We won&#8217;t send you spam. Unsubscribe at any time.</span>
  </form>
</div>

<script src="https://convertkit.com/assets/CKJS4.js"></script>



  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/theden/the-tremendous-scale-of-aws-and-the-hidden-benefit-of-the-cloud/">The Tremendous Scale of AWS and the Hidden Benefit of the Cloud</a></h1>
    
    
      <p class="meta">
        
  

<span class="byline author vcard"><span class="fn"><a href="/team/jarkko/" rel="author">Jarkko</a></span> wrote this on </span>

        




<time class='entry-date' datetime='2015-02-03T15:14:35+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>3:14 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure markdown="1">
  <a href="https://www.flickr.com/photos/infomastern/14852324010/">
    <img src="https://farm4.staticflickr.com/3918/14852324010_9a0d2d1887_b.jpg">
  </a>

  <figcaption>
    <p>
      Photo by <a href="https://www.flickr.com/photos/infomastern/14852324010/">Susanne Nilsson</a>, used under a Creative Commons license.
    </p>
  </figcaption>
</figure>


<p>Finland, 2013. Vantaa, the second largest municipality in Finland buys a new web form for welfare applications from CGI (née Logica, née WM-Data) for a whopping €1.9 million. The story doesn&rsquo;t end there, though. A month later it turns out, that Helsinki has bought the exact same form from CGI as well, for €1.85 million.</p>

<p>Now, you can argue about what is a fair value for a single web form, especially when it has to be integrated to an existing information system. What is clear though, that it is not almost 2 million Euros, twice.</p>

<p>“How on earth was that possible,” I hear you ask. Surely someone would have offered to do that form for, say, 1 million a pop. Heck, even the Finnish law for public procurements mandates public competitive bidding for such projects.</p>

<p>Vendor lock-in. CGI was administering the information system on which the form was to be built. And since they held the key, they could pretty much ask for as much as the municipalities could potentially pay for the form.</p>

<p>Now hold that thought.</p>

<hr />

<p>Over at <a href="http://highscalability.com/blog/2015/1/12/the-stunning-scale-of-aws-and-what-it-means-for-the-future-o.html">High Scalability</a>, Todd Hoff writes about James Hamilton&rsquo;s talk at the AWS re:Invent conference last November. It reveals how gigantic the scale of Amazon Web Services really is:</p>

<blockquote><p>Every day, AWS adds enough new server capacity to support all of Amazon’s global infrastructure when it was a $7B annual revenue enterprise (in 2004).</p></blockquote>

<p>This also means that AWS is leaps and bounds above its competitors when it comes to capacity:</p>

<blockquote><p>All 14 other cloud providers combined have 1/5th the aggregate capacity of AWS (estimate by Gartner)</p></blockquote>

<p>This of course gives AWS a huge benefit compared to its competitors. It can run larger datacenters both close and far from each others; they can get sweetheart deals and custom-made components from Intel for servers, just like Apple does with laptops and desktops. And they can afford to design their own network gear, the one field where the progress hasn&rsquo;t followed the Moore&rsquo;s law. There the only other companies who do the same are other internet giants like Google and Facebook, but they&rsquo;re not in the same business as AWS<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>.</p>

<p>All this is leading to a situation where <strong>AWS is becoming the IBM of the 21st century</strong>, for better or for worse. Just like no one ever got fired for buying IBM in the 80&rsquo;s, few will likely get fired for choosing AWS in the years to come. This will be a tough, tough nut to crack for Amazon&rsquo;s competitors.</p>

<p>So far the situation doesn&rsquo;t seem to have slowed down Amazon&rsquo;s rate of innovation, and perhaps they have learned the lessons of the big blue. Only future will tell.</p>

<p>From a customer&rsquo;s perspective, a cloud platform like AWS brings lots and lots of benefits – well listed in the article above – but of course also downsides. Computing power is still much cheaper when bought in physical servers. You can rent a monster Xeon server with basically unlimited bandwidth for less than €100/month. AWS or platforms built on it such as Heroku can&rsquo;t compete with that on price. So if you&rsquo;re very constrained on cash and have the sysadmin chops to operate the server, you will get a better deal.</p>

<p>Of course we&rsquo;re comparing apples and oranges here. You won&rsquo;t get similar redundancy and flexibility with physical servers as you can with AWS for any money – except when you do. The second group where using a commercial cloud platform doesn&rsquo;t make sense is when your scale merits a cloud platform of your own. Open source software for such platforms – such as Docker and Flynn – are slowly at a point where you can rent your own servers and basically build your own AWS on them<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>. Of course this will take a lot more knowledge from your operations team, especially if you want to attain similar redundancy and high availability that you can with AWS Availability Zones.</p>

<p>There is – however – one hidden benefit of going with a commercial cloud platform such as AWS, that you might not have thought about: <em>going with AWS will lessen your vendor lock-in a lot</em>. Of course you can still shoot yourself in the foot by handing off the intellectual property rights of the software to your vendor or some other braindead move. But given that you won&rsquo;t, hosting is another huge lock-in mechanism large IT houses use to screw their clients. It not only effectively locks the client to the vendor, but it also massively slows down any modifications made by other projects that need to integrate with the existing system, since everything needs to be handled through the vendor. They can, and will, block any progress you could make yourself.</p>

<p>With AWS, you can skip all of that. You are not tied to a particular vendor to develop, operate, and extend your system. While running apps on PaaS platforms requires some specific knowledge, it is widely available and standard. If you want to take your systems to another provider, you can. If you want to build your own cloud platform, you can do it and move your system over bit by bit.</p>

<p>It is thus no wonder that large IT consultancies are racing to build their own platforms, to hit all the necessary buzzword checkboxes. However, I would be very wary of their offerings. I&rsquo;m fairly certain the savings they get from better utilization of their servers by virtualization are not passed on to the customer. And even if some of them are, the lock-in is still there. They have absolutely no incentive to make their platform compatible with the existing ones, quite the contrary. Lock-in is on their side. It is not on your side. Beware.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Apart from Google Computing Engine, but even it doesn&rsquo;t provide a similar generic cloud platform that AWS does.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p>If you’re at such a state, we can <a href="https://bearmetal.eu/services/">help</a>, by the way. The same goes for building a server environment on AWS, of course.<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
    <div id="ck_embed_form" class="ck_embed_form row">
  <div class="small-12 large-6 columns" id="ck_form_content">
    <h3 class="ck_embed_form_title">Get our Secrets of Successful Web Apps email course for free!</h3>
    <div class="ck_embed_description">
      <span class="ck_image">

      </span>
        <p>Sign up to get the lessons we&#8217;ve spent more than a decade learning straight to your inbox. 100% meat, no spam, ever.</p>
    </div>
  </div>
<div id='ck_success_msg' class='fade' style='display:none;'>
  <p>Thanks! Now check your email, confirm your subscription, and off we go!</p>
</div>
  <!--  Form starts here  -->
  <form id="ck_subscribe_form" class="small-12 large-6 columns" action="https://convertkit.com/app/landing_pages/259/subscribe">
    <input type="hidden" name="id" value="259" id="landing_page_id"></input>
    <p class="ck_errorArea"></p>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_firstNameField">First Name</label>
      <input type="text" name="first_name" class="ck_first_name" id="ck_firstNameField"></input>
    </div>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_emailField">Email Address</label>
        <input type="email" name="email" class="ck_email_address" id="ck_emailField"></input>
    </div>
    <label class="ck_checkbox">
      <input class="optIn ck_course_opted" type="checkbox" id="optIn" checked />
      I&#8217;d like to receive a free 30 day course by email.
    </label>

    <button class="subscribe_button ck_subscribe_button btn fields" id='ck_subscribe_button'>
      Claim my spot on the course
    </button>
    <span class="ck_guarantee">We won&#8217;t send you spam. Unsubscribe at any time.</span>
  </form>
</div>

<script src="https://convertkit.com/assets/CKJS4.js"></script>



  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/theden/of-course-you-may-eat-your-own-food-here/">Of Course You May Eat Your Own Food Here</a></h1>
    
    
      <p class="meta">
        
  

<span class="byline author vcard"><span class="fn"><a href="/team/jarkko/" rel="author">Jarkko</a></span> wrote this on </span>

        




<time class='entry-date' datetime='2015-02-02T16:00:18+02:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span> <span class='time'>4:00 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Are you with or against your customers?</p>

<p>Do your signs read like those “Private property. Keep out!” signs? “No eating of own food”. “Food may not be taken out of the restaurant!” Don&rsquo;t you have more important things to care about, like, whether your customers love you?</p>

<p>I recently saw this sign on the outside wall of a small roadside restaurant<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>

<p><img src="/images/IMG_2928.JPG" alt="" /></p>

<p>It reads: “You may of course eat your own food here as well.”</p>

<p>So, why should you be more like Tiinan Tupa and less like ABC?</p>

<p>First of all, very few people will probably abuse it. Even if someone eats their own lunch packs there, they will probably reciprocate and buy something as a favor to the place.</p>

<p>Second, it is the ultimate <a href="http://www.sethgodin.com/purple/">purple cow</a>. It is something unexpected, something remarkable people will pay attention to. People are so accustomed to passive-aggressive notes forbidding this and that that a sign being actually nice will be noticed and talked about.</p>

<p>Lastly, and most importantly, it&rsquo;s just plain being nice. So stop just using glorious and empty words about how you care about your customers and actually walk the walk.</p>

<p>For these three reasons, being ridiculously admitting with your customers will probably also be good for you in the long term. So stop picking nickels in front of bulldozers. Make sure people will give you money <em>because they love you</em>, not because they <em>have to</em>.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>Coincidentally, I found it on Vaihtoehto ABC:lle, a site and an app dedicated to finding alternatives to the ubiquitous, generic and boring ABC gas station chain that seems to have infiltrated the whole country in just a couple of years. ABC specifically forbids eating food bought from its own supermarket in the cafeteria of the same gas station.<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
    <div id="ck_embed_form" class="ck_embed_form row">
  <div class="small-12 large-6 columns" id="ck_form_content">
    <h3 class="ck_embed_form_title">Get our Secrets of Successful Web Apps email course for free!</h3>
    <div class="ck_embed_description">
      <span class="ck_image">

      </span>
        <p>Sign up to get the lessons we&#8217;ve spent more than a decade learning straight to your inbox. 100% meat, no spam, ever.</p>
    </div>
  </div>
<div id='ck_success_msg' class='fade' style='display:none;'>
  <p>Thanks! Now check your email, confirm your subscription, and off we go!</p>
</div>
  <!--  Form starts here  -->
  <form id="ck_subscribe_form" class="small-12 large-6 columns" action="https://convertkit.com/app/landing_pages/259/subscribe">
    <input type="hidden" name="id" value="259" id="landing_page_id"></input>
    <p class="ck_errorArea"></p>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_firstNameField">First Name</label>
      <input type="text" name="first_name" class="ck_first_name" id="ck_firstNameField"></input>
    </div>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_emailField">Email Address</label>
        <input type="email" name="email" class="ck_email_address" id="ck_emailField"></input>
    </div>
    <label class="ck_checkbox">
      <input class="optIn ck_course_opted" type="checkbox" id="optIn" checked />
      I&#8217;d like to receive a free 30 day course by email.
    </label>

    <button class="subscribe_button ck_subscribe_button btn fields" id='ck_subscribe_button'>
      Claim my spot on the course
    </button>
    <span class="ck_guarantee">We won&#8217;t send you spam. Unsubscribe at any time.</span>
  </form>
</div>

<script src="https://convertkit.com/assets/CKJS4.js"></script>



  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/theden/help-my-rails-app-is-melting-under-the-launch-day-load/">Help! My Rails App Is Melting Under the Launch Day Load</a></h1>
    
    
      <p class="meta">
        
  

<span class="byline author vcard"><span class="fn"><a href="/team/jarkko/" rel="author">Jarkko</a></span> wrote this on </span>

        




<time class='entry-date' datetime='2015-01-12T13:39:00+02:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:39 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure markdown="1">
  <a href="https://www.flickr.com/photos/pasukaru76/4484360302">
    <img src="https://farm5.staticflickr.com/4065/4484360302_70ac4b6a8d_o_d.jpg">
  </a>

  <figcaption>
    <p>
      Photo by <a href="https://www.flickr.com/photos/pasukaru76/4484360302">Pascal</a>
    </p>
  </figcaption>
</figure>


<p>It was to be our day. The Finnish championship relay in orienteering was about to be held close to us, in a terrain type we knew inside and out. We had a great team, with both young guns and old champions. My friend Samuli had been fourth in the individual middle distance championships the day before. My only job was to handle the first leg securely and pass the baton to the more experienced and tougher guys who would then take care of our success. And I failed miserably.</p>

<p>My legs were like dough from the beginning. I was supposed to be in good shape, but I couldn&rsquo;t keep up with anyone. I was supposed to take it easy and orienteer cleanly, but I ran like a headless chicken, making a mistake after another. Although I wouldn&rsquo;t learn the term until years later, this was my crash course to <a href="http://en.wikipedia.org/wiki/Ego_depletion">ego depletion</a>.</p>

<hr />

<p>The day before the relay we organized the middle distance Finnish champs in my old hometown Parainen. For obvious reasons, I was the de facto webmaster of our club pages, which also hosted the result service. The site was running on OpenACS, a system running on TCL I had a year or so of work experience with. I was supposed to know it.</p>

<p>After the race was over, I headed back to my friend&rsquo;s place, opened up my laptop… only to find out that the local orienteering forums were ablaze with complaints about our results page being down. Crap.</p>

<p>After hours or hunting down the issue, getting help on the OpenACS IRC channel, serving the results from a static page meanwhile, I finally managed to fix the issue. The app wasn&rsquo;t running enough server processes to keep up with the load. And the most embarrassing thing was that <em>the load wasn&rsquo;t even that high</em> – from high dozens to hundreds of simultaneous users. I headed to bed with my head spinning, hoping to scramble up my self confidence for the next day&rsquo;s race (with well-known results).</p>

<p>What does this have to do with Ruby or Rails? Nothing, really. And yet everything. The point is that most of us have a similar story to share. It&rsquo;s much more common to have a meltdown story with a reasonably low number of users than actually have a slashdotting/hackernewsing/daring fireball hit your app. If you aren&rsquo;t old enough to have gone through something like this, you probably will. But you don&rsquo;t have to.</p>

<hr />

<p>During the dozen or so years since the aforementioned episode, I&rsquo;ve gone through some serious loads. Some of them we have handled badly, but most – including the <a href="http://wildfireapp.blogspot.fi/2009/04/wildfire-runs-facebook-site-governance.html">Facebook terms of service vote campaign</a> – with at least reasonable grace. This series of articles about Rails performance builds upon those war stories.</p>

<p>We have already posted a couple of articles to start off the series.</p>

<ol>
<li><a href="/theden/rails-garbage-collection-naive-defaults/">Rails Garbage Collection: Naive Defaults</a></li>
<li><a href="/theden/does-rails-scale/">Does Rails Scale?</a></li>
<li><a href="/theden/rails-garbage-collection-age-matters/">Rails Garbage Collection: Age Matters</a></li>
</ol>


<p>This article will serve as kind of a belated intro to the series, introducing our high level principles regarding the subject but without going more to the details.</p>

<h2>The Bear Metal ironclad rules of Rails performance</h2>

<h3>Scalability is not the same as performance</h3>

<p>As I already noted in <a href="/theden/does-rails-scale/">Does Rails Scale?</a>, it&rsquo;s worth pointing out that performance is not the same thing as scalability. They are related for sure. But you can perform similarly poorly from your first to your millionth user and be “scalable”. There is also the difference that performance is right here and now. If your app scales well, you can just throw more hardware (virtual or real) at the problem and solve it by that.</p>

<p>The good news is that Rails scales quite well out of the box for the vast majority of real-world needs. You probably won&rsquo;t be the next Twitter or even Basecamp. In your dreams and VC prospectus maybe, but let&rsquo;s be honest, the odds are stacked against you. So don&rsquo;t sweat about that too much.</p>

<p>Meanwhile, you do want your app to perform well enough for your initial wave of users.</p>

<h3>Perceived performance is what matters</h3>

<p>There are basically three different layers of performance for any web app: the server level (I&rsquo;m bundling everything from the data store to the frontend server here), browser rendering and the performance perceived by the user. The two latter ones are very close to each other but not exactly the same. You can tweak the perceived performance with tricks on the UI level, something that often isn&rsquo;t even considered performance.</p>

<p>The most important lesson here is that the perceived performance is what matters. It makes no difference what your synthetic performance tests on your server say if the UI of the app feels sluggish. There is no panacea to solve this, but make no mistake, it is what matters when the chicken come home to roost.</p>

<h3>Start with quick, large, and obvious wins</h3>

<p>The fact is that even a modest amount of users can make your app painfully slow. The good thing is that you can probably fix that just with hitting the low-hanging fruit. You won&rsquo;t believe how many Rails apps reveal that they&rsquo;re running in the development mode even in production by – when an error occurs – leaking the whole error trace out to the end user.</p>

<p>Other examples of issues that are fairly easy to spot and fix are N+1 query issues with ActiveRecord associations, missing database indeces, and running a single, non-concurrent app server instance, where any longer-running action will block the whole app from other users.</p>

<h3>YAGNI</h3>

<p>Once you have squashed all the low-hanging fruit with your metal-reinforced bat, relax. Tuning app performance shouldn&rsquo;t be your top priority at the moment – unless it is, but in that case you will know for sure. What you should be focusing on is how to get paying customers and how you can make them kick ass. If you have clear performance issues, by all means fix them. However…</p>

<h3>Don&rsquo;t assume, measure</h3>

<p>You probably don&rsquo;t have any idea how many users your app needs to support from the get go. That&rsquo;s fine. The reality will teach you. As long as you don&rsquo;t royally fuck up the share nothing (and 12 factor if you&rsquo;re on a cloud platform such as Heroku) architecture, you should be able to react to issues quickly.</p>

<p>That said, you probably do want to do some baseline load testing with your app if you&rsquo;re opening for a much larger private group or the public. The good news is that it is very cheap to spin up a virtual server instance just for a couple of hours and hit your app hard with it. Heck, you can handle the baseline from your laptop if needed. With that you should be able to get over the initial, frightening launch.</p>

<p>Once your app is up and running under load from real users, your tuning work starts for real. Only now will you be able to measure where the real hot paths and bottlenecks in your app are, based on real usage data, not just assumptions. At this point you&rsquo;ll have a plethora of tools at your disposal, from the good old <a href="https://github.com/wvanbergen/request-log-analyzer">request log analyzer</a> to commercial offerings such as <a href="https://www.skylight.io">Skylight</a>, and <a href="http://newrelic.com">New Relic</a>.</p>

<p>On the frontend most browsers have nowadays developer tools to optimize end-user performance, from Chrome and Safari&rsquo;s built-in developer tools to <a href="http://getfirebug.com">Firebug</a> for Firefox.</p>

<h2>Wrap-up</h2>

<p>In this introductory article to building performant Rails (or any, for that matter) web apps, we took a look at five basic rules of performance optimization:</p>

<ol>
<li>Scalability is not the same as performance.</li>
<li>Perceived performance is what matters.</li>
<li>Start with the low-hanging fruit.</li>
<li>YAGNI</li>
<li>Don&rsquo;t assume, measure.</li>
</ol>


<p>We will get (much) more in the details of Rails performance optimization in later articles. At that point we&rsquo;ll enter a territory where one size does not fit all anymore. However, whatever your particular performance problem is, you should keep the five rules above at the top your mind.</p>
</div>
  
  


    </article>
    <div id="ck_embed_form" class="ck_embed_form row">
  <div class="small-12 large-6 columns" id="ck_form_content">
    <h3 class="ck_embed_form_title">Get our Secrets of Successful Web Apps email course for free!</h3>
    <div class="ck_embed_description">
      <span class="ck_image">

      </span>
        <p>Sign up to get the lessons we&#8217;ve spent more than a decade learning straight to your inbox. 100% meat, no spam, ever.</p>
    </div>
  </div>
<div id='ck_success_msg' class='fade' style='display:none;'>
  <p>Thanks! Now check your email, confirm your subscription, and off we go!</p>
</div>
  <!--  Form starts here  -->
  <form id="ck_subscribe_form" class="small-12 large-6 columns" action="https://convertkit.com/app/landing_pages/259/subscribe">
    <input type="hidden" name="id" value="259" id="landing_page_id"></input>
    <p class="ck_errorArea"></p>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_firstNameField">First Name</label>
      <input type="text" name="first_name" class="ck_first_name" id="ck_firstNameField"></input>
    </div>
    <div class="ck_control_group">
      <label class="ck_label" for="ck_emailField">Email Address</label>
        <input type="email" name="email" class="ck_email_address" id="ck_emailField"></input>
    </div>
    <label class="ck_checkbox">
      <input class="optIn ck_course_opted" type="checkbox" id="optIn" checked />
      I&#8217;d like to receive a free 30 day course by email.
    </label>

    <button class="subscribe_button ck_subscribe_button btn fields" id='ck_subscribe_button'>
      Claim my spot on the course
    </button>
    <span class="ck_guarantee">We won&#8217;t send you spam. Unsubscribe at any time.</span>
  </form>
</div>

<script src="https://convertkit.com/assets/CKJS4.js"></script>



  
  <div class="pagination">
    
      <a class="prev" href="/theden/2">&larr; Older</a>
    
    <a href="/theden/archives">Blog Archives</a>
    
  </div>
</div>
</section>

  <script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '51767878108d7b455f000154');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>
</body>
</html>